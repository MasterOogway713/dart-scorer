<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Voice DartsOS Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700;800&family=Oswald:wght@500;700&display=swap');

        :root {
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --active-card-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(185, 28, 28, 0.9));
            
            /* Player Colors */
            --p1-col: #ef4444; --p2-col: #3b82f6; --p3-col: #22c55e;
            --p4-col: #eab308; --p5-col: #a855f7; --p6-col: #f97316;
        }

        html, body { 
            height: 100%; 
            width: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.4), transparent 40%), 
                radial-gradient(circle at 85% 30%, rgba(13, 148, 136, 0.25), transparent 40%);
            background-repeat: no-repeat;
            background-size: cover;
            color: #fff;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-condensed { font-family: 'Oswald', sans-serif; }

        .glass-panel {
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .mobile-card {
            @apply glass-panel;
            border-radius: 1.5rem; transition: all 0.3s ease;
        }
        .mobile-card.active {
            border-color: rgba(255,255,255,0.3);
            box-shadow: 0 0 25px rgba(0,0,0, 0.4);
        }

        .dartboard-segment { transition: opacity 0.1s; cursor: pointer; stroke: #94a3b8; stroke-width: 1px; }
        .dartboard-segment:hover, .dartboard-segment.hover-highlight { 
            opacity: 1; stroke: #fff; stroke-width: 3px; 
            filter: brightness(1.5) drop-shadow(0 0 4px rgba(255,255,255,0.5)); z-index: 100;
        }
        .dartboard-text { font-family: 'JetBrains Mono'; font-weight: 800; fill: #fff; pointer-events: none; text-anchor: middle; dominant-baseline: middle; font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        .segment-highlight { fill: #f59e0b !important; filter: drop-shadow(0 0 8px #f59e0b); stroke: #fff; stroke-width: 2px; animation: pulse-gold 1s infinite; }
        @keyframes pulse-gold { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Dynamic Player Highlights */
        .highlight-p1 { fill: var(--p1-col) !important; filter: drop-shadow(0 0 8px var(--p1-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p1 1s infinite; }
        @keyframes pulse-p1 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .highlight-p2 { fill: var(--p2-col) !important; filter: drop-shadow(0 0 8px var(--p2-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p2 1s infinite; }
        @keyframes pulse-p2 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .highlight-p3 { fill: var(--p3-col) !important; filter: drop-shadow(0 0 8px var(--p3-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p3 1s infinite; }
        @keyframes pulse-p3 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .highlight-p4 { fill: var(--p4-col) !important; filter: drop-shadow(0 0 8px var(--p4-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p4 1s infinite; }
        @keyframes pulse-p4 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .highlight-p5 { fill: var(--p5-col) !important; filter: drop-shadow(0 0 8px var(--p5-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p5 1s infinite; }
        @keyframes pulse-p5 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .highlight-p6 { fill: var(--p6-col) !important; filter: drop-shadow(0 0 8px var(--p6-col)); stroke: #fff; stroke-width: 2px; animation: pulse-p6 1s infinite; }
        @keyframes pulse-p6 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Animation Classes */
        @keyframes pulseGreen { 
            0% { fill: #22c55e; stroke: #fff; stroke-width: 4px; filter: drop-shadow(0 0 15px #22c55e); transform: scale(1.02); } 
            50% { transform: scale(1); }
            100% { fill: initial; stroke: initial; stroke-width: 1px; filter: none; transform: scale(1); } 
        }
        .anim-checkout { animation: pulseGreen 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; z-index: 200; position: relative; }

        @keyframes stamp { 0% { transform: scale(3); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 70% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .anim-stamp { animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }
        .anim-shake { animation: shake 0.4s ease-in-out; }

        @keyframes flashWhite { 0% { fill: #fff; opacity: 1; stroke-width: 4px; } 100% { fill: initial; opacity: initial; stroke-width: 1px; } }
        .anim-flash { animation: flashWhite 0.4s ease-out; }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .anim-pop { animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .keypad-btn {
            background: rgba(255,255,255,0.03); font-family: 'Oswald', sans-serif; font-size: 1.8rem; color: white;
            border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center; transition: background 0.1s;
        }
        .keypad-btn:active { background: rgba(255,255,255,0.15); }

        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100; width: 100%; height: 100%; }
        
        .hit-marker {
            position: absolute; width: 20px; height: 20px;
            border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 50; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            border: 2px solid white;
        }
        .hit-marker.p1 { background: radial-gradient(circle, var(--p1-col) 30%, #000 90%); }
        .hit-marker.p2 { background: radial-gradient(circle, var(--p2-col) 30%, #000 90%); }
        .hit-marker.p3 { background: radial-gradient(circle, var(--p3-col) 30%, #000 90%); }
        .hit-marker.p4 { background: radial-gradient(circle, var(--p4-col) 30%, #000 90%); }
        .hit-marker.p5 { background: radial-gradient(circle, var(--p5-col) 30%, #000 90%); }
        .hit-marker.p6 { background: radial-gradient(circle, var(--p6-col) 30%, #000 90%); }
        
        .hit-marker.anim { animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1); }

        @keyframes ping { 0% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.5; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        #magnifier {
            position: fixed; pointer-events: none; z-index: 9999;
            width: 140px; height: 140px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.9);
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8); background: #0f172a;
            display: none; transform: translate(-50%, -130%);
        }
        #magnifier svg { width: 100%; height: 100%; display: block; }

        #one80-overlay { pointer-events: none; }
        .one80-text { font-size: 15vw; font-weight: 900; color: #facc15; text-shadow: 0 0 50px rgba(234, 179, 8, 0.8); animation: zoom-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes zoom-in { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        
        .mobile-tab-content { display: none; }
        .mobile-tab-content.active { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .cricket-row { display: flex; justify-content: space-between; font-family: 'JetBrains Mono'; font-size: 0.75rem; margin-top: 2px; }
        .cricket-mark { width: 18px; height: 18px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .cricket-closed { background: #22c55e; color: #000; }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-btn-active { animation: pulse-red 2s infinite; background-color: #b91c1c !important; border-color: #ef4444 !important; color: white !important; }
    </style>
</head>
<body class="flex flex-col h-[100dvh] text-slate-200 selection:bg-purple-500 selection:text-white overflow-hidden">

    <canvas id="confetti-canvas"></canvas>
    <div id="one80-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="one80-text">180!</div></div>
    
    <div id="magnifier"></div>

    <!-- HEADER -->
    <header class="hidden lg:flex glass-panel sticky top-0 z-40 h-16 items-center justify-between px-6 border-b-0 border-b-slate-700/50 rounded-b-2xl mx-4 mt-2 shrink-0">
        <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="App.setView('dashboard')">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg">D</div>
            <span class="font-bold text-xl tracking-tight text-white">Darts<span class="text-purple-400">OS</span></span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-white/5 rounded-xl p-1 border border-slate-600">
                <button onclick="Game.cycleMicMode()" class="px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 text-slate-400 flex items-center gap-2 transition" id="btn-mic-header-desk">
                    <span>üéôÔ∏è</span> <span id="lbl-mic-header-desk">OFF</span>
                </button>
                <button onclick="App.toggleInfo()" class="w-6 h-6 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-[10px] font-bold text-slate-300 transition" title="Voice Help">?</button>
            </div>
            <div class="w-px h-6 bg-white/10 mx-1"></div>
            <button onclick="Game.undo()" class="glass-panel px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-amber-400 flex items-center gap-2"><span>Undo</span></button>
            <button onclick="App.toggleStats()" class="glass-panel px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-cyan-400">Stats</button>
            <button onclick="App.openSettings()" class="glass-panel px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-blue-400">Settings</button>
        </div>
    </header>

    <header class="lg:hidden flex items-center justify-between p-4 z-40 shrink-0 bg-transparent">
        <button onclick="App.setView('dashboard')" class="glass-panel p-2 rounded-lg text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
        <div class="font-condensed text-lg font-bold uppercase tracking-widest text-white/90">DartsOS</div>
        <div class="flex gap-2">
            <div class="flex items-center glass-panel p-1 rounded-lg gap-1">
                <button onclick="Game.cycleMicMode()" class="p-1 px-2 rounded text-slate-400" id="btn-mic-header-mob">üéôÔ∏è</button>
                <button onclick="App.toggleInfo()" class="w-6 h-6 flex items-center justify-center rounded-full bg-white/10 text-[10px] font-bold text-slate-300">?</button>
            </div>
            <button onclick="Game.undo()" class="glass-panel p-2 rounded-lg text-amber-400">‚Ü©Ô∏è</button>
            <button onclick="App.toggleStats()" class="glass-panel p-2 rounded-lg text-cyan-400">üìä</button>
            <button onclick="App.openSettings()" class="glass-panel p-2 rounded-lg text-slate-300">‚öôÔ∏è</button>
        </div>
    </header>

    <main id="main-container" class="flex-grow relative overflow-hidden flex flex-col h-full lg:p-6 lg:gap-6">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="absolute inset-0 z-50 overflow-y-auto bg-[#020617] lg:bg-transparent">
            <div class="min-h-full flex flex-col items-center justify-center p-6">
                <div class="glass-panel p-8 rounded-3xl w-full max-w-4xl flex flex-col items-center border-slate-700/50">
                    <h1 class="text-5xl md:text-7xl font-bold text-white mb-2 tracking-tight text-center">Select Game</h1>
                    
                    <div class="flex items-center gap-4 mt-6 glass-panel px-6 py-3 rounded-xl mb-6">
                        <span class="text-sm font-bold text-slate-400 uppercase">Players</span>
                        <button onclick="App.updatePlayerCount(-1)" class="w-8 h-8 rounded bg-white/10 hover:bg-white/20 text-white font-bold">-</button>
                        <span id="dash-player-count" class="text-xl font-bold w-4 text-center">2</span>
                        <button onclick="App.updatePlayerCount(1)" class="w-8 h-8 rounded bg-white/10 hover:bg-white/20 text-white font-bold">+</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                        <button onclick="App.startGame('x01')" class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition border-slate-700/50 group flex flex-col items-center gap-3">
                            <div class="text-5xl group-hover:scale-110 transition">üéØ</div>
                            <h3 class="text-xl font-bold text-white">X01</h3>
                            <p class="text-slate-400 text-xs">501, 301, Double Out</p>
                        </button>
                        <button onclick="App.startGame('cricket')" class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition border-slate-700/50 group flex flex-col items-center gap-3">
                            <div class="text-5xl group-hover:scale-110 transition">üèè</div>
                            <h3 class="text-xl font-bold text-white">Cricket</h3>
                            <p class="text-slate-400 text-xs">Tactical Territory</p>
                        </button>
                        <button onclick="App.startGame('atc')" class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition border-slate-700/50 group flex flex-col items-center gap-3">
                            <div class="text-5xl group-hover:scale-110 transition">üï∞Ô∏è</div>
                            <h3 class="text-xl font-bold text-white">Clock</h3>
                            <p class="text-slate-400 text-xs">Around the World</p>
                        </button>
                    </div>
                    <div class="mt-8">
                        <button onclick="Game.loadGame()" id="resume-btn" class="hidden px-6 py-3 bg-green-600/20 text-green-400 font-bold rounded-xl border border-green-600/50 hover:bg-green-600/30">Resume Saved Game</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE GAME LAYOUT -->
        <div id="view-game-mobile" class="lg:hidden flex flex-col h-full p-4 gap-3">
            <div id="mob-active-card" class="mobile-card active w-full p-5 flex flex-col justify-between min-h-[30%] relative transition-all duration-500">
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-black/20 flex items-center justify-center font-bold text-sm border border-white/10">P<span id="mob-p-num">1</span></div>
                        <span class="font-bold text-base opacity-90" id="mob-p-name">Player 1</span>
                        <button onclick="App.openSettings()" class="ml-2 text-xs opacity-50 p-1 hover:opacity-100">‚úèÔ∏è</button>
                    </div>
                    <div class="bg-black/20 px-2 py-0.5 rounded text-xs font-mono font-bold border border-white/10" id="mob-legs">Legs: 0</div>
                </div>
                <!-- Score / Content Area -->
                <div class="flex justify-between items-end mt-1 mb-1">
                    <div class="font-condensed text-[5.5rem] leading-[0.85] font-bold tracking-tighter drop-shadow-md" id="mob-score">501</div>
                    <div class="flex flex-col items-end gap-1 mb-2">
                        <div class="bg-black/30 backdrop-blur rounded px-2 py-1 text-[10px] font-bold border border-white/10" id="mob-last">Last: -</div>
                    </div>
                </div>
                <!-- Cricket Grid Container (Hidden by default) -->
                <div id="mob-cricket-grid" class="hidden flex-col gap-1 mb-2"></div>

                <div class="flex justify-between text-[10px] font-bold opacity-80 mt-2 pt-3 border-t border-white/20">
                    <div class="flex flex-col">
                        <span class="opacity-60 uppercase">Turn</span>
                        <!-- Fixed Height added here: h-8 -->
                        <div class="flex gap-1 items-center h-8" id="mob-turn-score"><span class="opacity-50">0</span></div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="opacity-60 uppercase">Darts</span>
                        <span class="text-sm" id="mob-darts">0</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center px-1">
                <div class="font-condensed text-lg font-bold text-amber-400 uppercase tracking-wide" id="mob-status">Your Turn</div>
                <div class="text-xs text-slate-300 font-mono bg-white/5 px-2 py-1 rounded" id="mob-suggestion">Checkout: -</div>
            </div>

            <div class="glass-panel rounded-full p-1 flex shrink-0">
                <button onclick="App.setMobileTab('keypad')" class="flex-1 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-colors bg-white/10 text-white shadow-sm" id="tab-btn-keypad">Keypad</button>
                <button onclick="App.setMobileTab('board')" class="flex-1 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-colors text-slate-400 hover:text-white" id="tab-btn-board">Board</button>
                <button onclick="App.setMobileTab('voice')" class="flex-1 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-colors text-slate-400 hover:text-white" id="tab-btn-voice">Voice</button>
            </div>

            <div class="flex-grow relative overflow-hidden rounded-2xl glass-panel border-slate-700/30 min-h-0">
                <div id="mob-tab-keypad" class="mobile-tab-content active flex-col h-full p-3 gap-2">
                    <div class="h-12 flex items-center justify-between px-3 bg-black/20 rounded-xl border border-white/5 mb-1">
                        <div class="text-xl font-mono font-bold text-white/90" id="mob-input-display">Enter score</div>
                        <button onclick="Game.submitInputBuffer()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg">SUBMIT</button>
                    </div>
                    <div class="grid grid-cols-3 flex-grow gap-2">
                        <button class="keypad-btn" onclick="Game.inputDigit(1)">1</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(2)">2</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(3)">3</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(4)">4</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(5)">5</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(6)">6</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(7)">7</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(8)">8</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(9)">9</button>
                        <button class="keypad-btn text-sm font-bold text-red-400 border-red-900/50 bg-red-900/10" onclick="Game.processThrow(0, 1, 'Miss')">MISS</button>
                        <button class="keypad-btn" onclick="Game.inputDigit(0)">0</button>
                        <button class="keypad-btn text-sm font-bold text-slate-400" onclick="Game.clearInput()">DEL</button>
                    </div>
                </div>
                <div id="mob-tab-board" class="mobile-tab-content flex-col h-full relative">
                    <div class="h-10 flex items-center justify-center gap-2 border-b border-white/5 shrink-0 bg-black/20">
                        <div class="text-slate-500 text-xs italic">Touch & Hold to Zoom</div>
                    </div>
                    <div class="flex-grow relative flex items-center justify-center p-2 overflow-hidden" id="mob-board-container" style="touch-action: none;"></div>
                </div>
                <div id="mob-tab-voice" class="mobile-tab-content flex-col h-full p-6 gap-6 overflow-y-auto custom-scroll">
                    <div class="text-center">
                        <div class="text-4xl mb-4">üéôÔ∏è</div>
                        <h3 class="text-xl font-bold mb-2">Voice Control</h3>
                        <p class="text-sm text-slate-400 mb-6">"Triple 20", "Undo", "Next Turn"</p>
                        <div class="p-4 rounded-lg bg-white/5 border border-white/10 text-sm text-left space-y-2">
                            <p><strong>Commands:</strong></p>
                            <ul class="list-disc pl-4 text-slate-300">
                                <li>"Double 16", "25", "Bullseye"</li>
                                <li>"Next Turn", "Undo", "Correction"</li>
                                <li>"Score" (Reads current score)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <button id="btn-hold-speak" class="py-5 rounded-xl bg-indigo-600 border border-indigo-400 font-bold text-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 text-white">
                            <span>üéôÔ∏è</span> HOLD TO SPEAK
                        </button>
                        <div class="flex items-center gap-4 my-2">
                            <div class="h-px bg-white/10 flex-grow"></div>
                            <span class="text-xs text-slate-500 font-bold uppercase">OR TOGGLE MODE</span>
                            <div class="h-px bg-white/10 flex-grow"></div>
                        </div>
                        <button onclick="Game.setMicMode('single')" class="py-3 rounded-xl bg-slate-800/60 border border-slate-600 font-bold text-sm">Single Throw (Auto-off)</button>
                        <button onclick="Game.setMicMode('turn')" class="py-3 rounded-xl bg-slate-800/60 border border-slate-600 font-bold text-sm">Full Turn (3 Darts)</button>
                        <button onclick="Game.setMicMode('always')" class="py-3 rounded-xl bg-slate-800/60 border border-slate-600 font-bold text-sm">Always On</button>
                    </div>
                    <button onclick="Game.stopMic()" class="mt-2 py-3 rounded-xl bg-red-900/30 text-red-400 border border-red-900/50 font-bold text-sm">Stop Microphone</button>
                </div>
            </div>
        </div>

        <!-- DESKTOP GAME LAYOUT -->
        <div id="view-game-desktop" class="hidden w-full h-full flex-row gap-6 relative pb-2">
            <!-- Left Panel -->
            <div class="flex-grow flex flex-col gap-6 w-5/12 overflow-y-auto custom-scroll p-2 min-h-0">
                <!-- Player List Container -->
                <div id="desktop-player-list" class="flex flex-col gap-4">
                    <!-- Dynamic content generated by UI.render -->
                </div>

                <!-- Game Log -->
                <div class="glass-panel rounded-2xl p-4 flex-grow flex flex-col overflow-hidden min-h-[150px]">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-700 pb-2">Game Log</h3>
                    <div id="desktop-game-log" class="overflow-y-auto custom-scroll flex-grow font-mono text-xs space-y-1 text-slate-300"></div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="w-7/12 flex flex-col h-full relative gap-6">
                <div class="shrink-0 glass-panel rounded-2xl p-6 flex justify-between items-center bg-indigo-950/20">
                    <div>
                        <span class="text-xs uppercase text-indigo-300 font-bold">Turn Total</span>
                        <!-- Fixed Height added here: h-12 -->
                        <div id="desk-turn-total" class="flex gap-2 items-center text-white h-12">0</div>
                    </div>
                    <div class="text-right">
                        <div id="desk-status" class="text-2xl font-bold text-white">Ready</div>
                    </div>
                </div>
                <div class="glass-panel rounded-3xl flex-grow flex items-center justify-center p-8 bg-black/20 overflow-hidden relative" id="desk-board-container" style="touch-action: none;">
                    <!-- Miss button for desktop overlay -->
                    <button onclick="Game.processThrow(0, 1, 'Miss')" class="absolute bottom-6 right-6 px-6 py-3 rounded-xl bg-red-900/20 hover:bg-red-900/40 text-red-400 font-bold border border-red-900/50 transition z-30">
                        MISS
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="absolute inset-0 z-[80] bg-slate-900/95 backdrop-blur-xl hidden flex-col items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md border-slate-700 max-h-[90vh] overflow-y-auto custom-scroll">
            <h2 class="text-2xl font-bold text-white mb-6">Settings & Rules</h2>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs uppercase text-slate-400 font-bold">Player Names</label>
                    <div id="settings-player-inputs" class="space-y-2">
                        <!-- Dynamic Inputs -->
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-xs uppercase text-slate-400 font-bold">Match Format</label>
                    <div class="flex items-center gap-4">
                        <span class="text-sm">First to</span>
                        <input type="number" id="set-legs" value="3" min="1" max="21" class="w-16 bg-slate-800/50 border border-slate-600 rounded p-2 text-white text-center" onchange="Game.matchConfig.legsToWin = parseInt(this.value)">
                        <span class="text-sm">Legs</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs uppercase text-slate-400 font-bold">X01 Rules</label>
                    <div class="flex gap-2">
                        <button onclick="Game.matchConfig.doubleOut=true; UI.updateSettingsUI()" id="btn-do" class="flex-1 py-2 rounded bg-indigo-600 text-xs font-bold">Double Out</button>
                        <button onclick="Game.matchConfig.doubleOut=false; UI.updateSettingsUI()" id="btn-so" class="flex-1 py-2 rounded bg-slate-700 text-xs font-bold">Straight Out</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="Game.manualEditScore()" class="col-span-2 p-4 rounded bg-amber-600/20 text-amber-400 font-bold hover:bg-amber-600/30 border border-amber-600/50 flex items-center justify-center gap-2">
                        <span>‚úèÔ∏è</span> Edit Score
                    </button>
                    <button onclick="App.startGame(Game.mode); App.closeSettings()" class="col-span-2 p-4 rounded bg-red-900/50 text-white font-bold hover:bg-red-800 border border-red-700">Restart Game</button>
                </div>
                <button onclick="App.closeSettings()" class="w-full p-4 rounded bg-slate-700 text-white font-bold mt-2">Close</button>
            </div>
        </div>
    </div>

    <!-- INFO MODAL -->
    <div id="info-modal" class="absolute inset-0 z-[85] bg-slate-900/95 backdrop-blur-xl hidden flex-col items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-lg border-slate-700 max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Voice Commands & Help</h2>
                <button onclick="App.toggleInfo()" class="text-2xl text-slate-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-indigo-400 text-sm font-bold uppercase tracking-widest mb-3 border-b border-indigo-500/30 pb-1">Microphone Modes</h3>
                    <div class="grid gap-3">
                        <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-blue-400 text-sm">SINGLE</span>
                                <span class="text-[10px] bg-blue-900/50 text-blue-200 px-2 py-0.5 rounded">Click 1x</span>
                            </div>
                            <p class="text-xs text-slate-400">Mic turns off automatically after recognizing one valid score. Best for noisy rooms.</p>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-orange-400 text-sm">TURN</span>
                                <span class="text-[10px] bg-orange-900/50 text-orange-200 px-2 py-0.5 rounded">Click 2x</span>
                            </div>
                            <p class="text-xs text-slate-400">Mic stays on for 3 darts (one full turn), then turns off.</p>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-red-400 text-sm">ALWAYS</span>
                                <span class="text-[10px] bg-red-900/50 text-red-200 px-2 py-0.5 rounded">Click 3x</span>
                            </div>
                            <p class="text-xs text-slate-400">Mic stays on indefinitely until you manually turn it off.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-emerald-400 text-sm font-bold uppercase tracking-widest mb-3 border-b border-emerald-500/30 pb-1">Voice Commands</h3>
                    <ul class="space-y-2 text-sm text-slate-300">
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Triple 20"</span> <span>Scores 60 points. Works for Single, Double, Triple.</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"25"</span> <span>Scores Outer Bull (Green).</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Bullseye"</span> <span>Scores Inner Bull (Red, 50).</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Undo"</span> <span>Removes the last dart thrown.</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Correction"</span> <span>Same as Undo. Useful if it misheard you.</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Next Turn"</span> <span>Ends current player's turn.</span></li>
                        <li class="flex gap-3"><span class="text-white font-mono w-24 shrink-0">"Score"</span> <span>Reads out your current remaining score.</span></li>
                    </ul>
                </div>
            </div>
            
            <button onclick="App.toggleInfo()" class="w-full mt-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition">Got it</button>
        </div>
    </div>

    <!-- STATS MODAL -->
    <div id="stats-modal" class="absolute inset-0 z-[75] bg-slate-900/95 backdrop-blur-xl hidden flex-col items-center justify-center p-4">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-4xl border-slate-700 max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Match Statistics</h2>
                <button onclick="App.toggleStats()" class="text-2xl">‚úï</button>
            </div>
            
            <div id="stats-container" class="overflow-x-auto">
                <!-- Dynamic Stats Table -->
            </div>
        </div>
    </div>

    <!-- LOG MODAL (Mobile) -->
    <div id="mobile-log-modal" class="fixed inset-0 z-[70] bg-slate-900/95 backdrop-blur-xl hidden flex-col p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Match History</h2>
            <button onclick="App.toggleMobileLog()" class="text-slate-400 text-xl">‚úï</button>
        </div>
        <div id="mobile-game-log" class="overflow-y-auto custom-scroll flex-grow font-mono text-sm space-y-2 text-slate-300"></div>
    </div>

    <div id="winner-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-xl hidden flex-col items-center justify-center text-center p-6">
        <div class="text-8xl mb-6 animate-bounce">üèÜ</div>
        <h1 id="winner-name" class="text-4xl md:text-6xl font-black text-white mb-2">Player 1 Wins!</h1>
        <div class="flex gap-4 mt-8">
             <button onclick="Game.nextLeg(); document.getElementById('winner-modal').classList.add('hidden'); document.getElementById('winner-modal').classList.remove('flex');" class="bg-white text-slate-900 px-10 py-4 rounded-2xl font-bold">Next Leg</button>
        </div>
    </div>

    <script>
        const AudioEngine={ctx:null,init:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(!this.ctx)this.ctx=new AudioContext},playTone:function(e,t,n){if(!this.ctx)this.init();if("suspended"===this.ctx.state)this.ctx.resume();const o=this.ctx.createOscillator(),a=this.ctx.createGain();o.type=t,o.frequency.setValueAtTime(e,this.ctx.currentTime),a.gain.setValueAtTime(0,this.ctx.currentTime),a.gain.linearRampToValueAtTime(.15,this.ctx.currentTime+.02),a.gain.exponentialRampToValueAtTime(.001,this.ctx.currentTime+n),o.connect(a),a.connect(this.ctx.destination),o.start(),o.stop(this.ctx.currentTime+n)},playHit:function(){this.playTone(400,"sine",.15)},playDouble:function(){this.playTone(600,"triangle",.2)},playTriple:function(){this.playTone(800,"square",.15)},playBust:function(){this.playTone(150,"sawtooth",.4)},playWin:function(){if(!this.ctx)this.init();[523.25,659.25,783.99,1046.5].forEach(((e,t)=>setTimeout((()=>this.playTone(e,"triangle",.3)),150*t)))},play180:function(){this.playWin(),this.speak("One Hundred and Eighty!")},
        speak:function(text){
            if(window.speechSynthesis){
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.1; u.pitch = 1.0;
                window.speechSynthesis.speak(u);
            }
        }};
        const Confetti={canvas:document.getElementById("confetti-canvas"),ctx:document.getElementById("confetti-canvas").getContext("2d"),particles:[],active:!1,init:function(){this.resize(),window.addEventListener("resize",(()=>this.resize()))},resize:function(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight},start:function(){this.active=!0,this.particles=[];for(let e=0;e<150;e++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height-this.canvas.height,color:["#a864fd","#29cdff","#78ff44","#ff718d","#fdff6a"][Math.floor(5*Math.random())],size:4*Math.random()+4,speedY:3*Math.random()+2,speedX:2*Math.random()-1,rotation:360*Math.random(),rotationSpeed:10*Math.random()-5});this.loop()},loop:function(){if(!this.active)return void this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.particles.forEach((e=>{e.y+=e.speedY,e.x+=e.speedX,e.rotation+=e.rotationSpeed,e.y>this.canvas.height&&(e.y=-20),this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(e.rotation*Math.PI/180),this.ctx.fillStyle=e.color,this.ctx.fillRect(-e.size/2,-e.size/2,e.size,e.size),this.ctx.restore()})),requestAnimationFrame((()=>this.loop()))},stop:function(){this.active=!1; if(this.ctx) this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); }};

        const PlayerColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7', '#f97316'];

        const Game = {
            mode: 'x01', scores: [], legs: [], currentPlayer: 0,
            turn: { dartsThrown: 0, score: 0, history: [], darts: [], startScore: 501, bust: false, won: false, markers: [] },
            historyStack: [], inputBuffer: '', 
            settings: { startScore: 501 },
            matchConfig: { legsToWin: 3, doubleOut: true, playerCount: 2, playerNames: [] },
            micMode: 'off', recognition: null, isListening: false, gameLog: [],
            cricket: [], atc: [],
            playerStats: [],

            init: function(mode, resetLegs = true) {
                this.mode = mode || 'x01';
                
                // Ensure names array matches count (Bug Fix)
                while(this.matchConfig.playerNames.length < this.matchConfig.playerCount) {
                    this.matchConfig.playerNames.push(`Player ${this.matchConfig.playerNames.length+1}`);
                }
                if(this.matchConfig.playerNames.length > this.matchConfig.playerCount) {
                    this.matchConfig.playerNames = this.matchConfig.playerNames.slice(0, this.matchConfig.playerCount);
                }

                if(resetLegs) { 
                    this.currentPlayer = 0;
                    this.legs = new Array(this.matchConfig.playerCount).fill(0);
                    this.playerStats = Array.from({length: this.matchConfig.playerCount}, () => ({
                        totalScore: 0, totalDarts: 0, first9Score: 0, first9Darts: 0, checkoutAttempts: 0, checkoutHits: 0, s100:0, s140:0, s180:0 
                    }));
                    this.gameLog = [];
                }
                
                this.cricket = Array.from({length: this.matchConfig.playerCount}, () => ({20:0,19:0,18:0,17:0,16:0,15:0,25:0}));
                this.atc = new Array(this.matchConfig.playerCount).fill(1);
                
                let start = 501;
                if(mode === '301') { this.mode='x01'; start=301; }
                else if(mode === 'x01') start=501;
                else if(mode === 'cricket') start=0; 
                else if(mode === 'atc') start=1;

                this.settings.startScore = start;
                this.scores = new Array(this.matchConfig.playerCount).fill(start);
                
                this.resetTurn();
                Confetti.init(); Confetti.stop(); 
                AudioEngine.init(); this.initMic();
                document.getElementById('winner-modal').classList.add('hidden');
                document.getElementById('winner-modal').classList.remove('flex');
                
                if(resetLegs) {
                    this.logAction(`Match Started: ${this.mode.toUpperCase()}`);
                } else {
                    this.logAction(`Leg Started`);
                }
                
                UI.render();
                this.persist();
            },
            updatePlayerName: function(idx, name) {
                this.matchConfig.playerNames[idx] = name || `Player ${idx+1}`;
                UI.render();
            },
            nextLeg: function() {
                this.init(this.mode, false);
            },
            resetTurn: function() {
                let start = this.scores[this.currentPlayer];
                this.turn = { 
                    dartsThrown: 0, score: 0, history: [], darts: [], 
                    startScore: start, bust: false, won: false, markers: [] 
                };
                document.querySelectorAll('.hit-marker').forEach(e => e.remove());
            },
            processThrow: function(points, multiplier, label, coords) {
                if(this.turn.won || this.turn.bust || this.turn.dartsThrown >= 3) return;
                this.saveState();
                
                if (coords) UI.drawMarker(coords.x, coords.y, this.currentPlayer);

                if(points===0) AudioEngine.playTone(150,'sawtooth',0.1);
                else if(multiplier===3) AudioEngine.playTriple();
                else if(multiplier===2) AudioEngine.playDouble();
                else AudioEngine.playHit();

                if(this.mode === 'x01') this.handleX01(points, multiplier, label);
                else if(this.mode === 'cricket') this.handleCricket(points, multiplier, label);
                else if(this.mode === 'atc') this.handleATC(points, multiplier, label);

                // Caller Logic
                if (this.mode === 'x01' && this.turn.dartsThrown === 3 && !this.turn.bust && !this.turn.won) {
                    if (this.turn.score === 180) AudioEngine.speak("One Hundred and Eighty");
                    else if (this.turn.score >= 140) AudioEngine.speak("One Hundred and Forty");
                    else if (this.turn.score >= 100) AudioEngine.speak("One Hundred");
                    else AudioEngine.speak(this.turn.score.toString());
                }

                UI.render();
                this.persist();
                
                if(this.turn.dartsThrown >= 3 && !this.turn.bust && !this.turn.won) setTimeout(() => this.nextTurn(), 1000);
            },
            updateStats: function(points, isCheckoutAttempt, isCheckoutHit) {
                const ps = this.playerStats[this.currentPlayer];
                ps.totalScore += points;
                ps.totalDarts++;
                if (this.turn.score >= 100 && this.turn.score < 140 && this.turn.dartsThrown === 3) ps.s100++;
                if (this.turn.score >= 140 && this.turn.score < 180 && this.turn.dartsThrown === 3) ps.s140++;
                if (this.turn.score === 180 && this.turn.dartsThrown === 3) ps.s180++;
                if(isCheckoutAttempt) ps.checkoutAttempts++;
                if(isCheckoutHit) ps.checkoutHits++;
            },
            handleX01: function(points, mul, label) {
                const rem = this.scores[this.currentPlayer] - points;
                let bust = false;
                const isDouble = mul === 2 || label.includes("Bullseye");
                let checkoutAtt = false;
                if (this.matchConfig.doubleOut && this.scores[this.currentPlayer] <= 50) checkoutAtt = true; 
                
                if (this.matchConfig.doubleOut) {
                    if (rem < 0 || rem === 1 || (rem === 0 && !isDouble)) bust = true;
                } else {
                    if (rem < 0) bust = true;
                }

                const currentScore = this.scores[this.currentPlayer];
                const suggested = UI.getCheckout(currentScore);
                if (suggested && !bust) {
                    const target = suggested.split(' ')[0];
                    let code = "";
                    if(points === 50) code = "Bull";
                    else if(points === 25) code = "25";
                    else if(mul === 3) code = "T" + (points/3);
                    else if(mul === 2) code = "D" + (points/2);
                    else code = "" + points;
                    if (target === code) UI.flashCheckout(points, mul);
                }

                if(bust) {
                    this.turn.bust = true; AudioEngine.playBust();
                    AudioEngine.speak("Bust");
                    this.logAction(`${this.pName()} BUST (${label})`);
                    document.body.classList.add('anim-shake');
                    setTimeout(() => document.body.classList.remove('anim-shake'), 400);
                    this.scores[this.currentPlayer] = this.turn.startScore;
                    this.updateStats(0, checkoutAtt, false);
                    setTimeout(() => this.nextTurn(), 1500);
                } else {
                    this.scores[this.currentPlayer] = rem;
                    this.turn.score += points;
                    this.turn.dartsThrown++;
                    this.turn.history.push(label);
                    this.turn.darts.push(points);
                    this.logAction(`${this.pName()}: ${label}`);
                    this.updateStats(points, checkoutAtt, rem === 0);
                    if(rem === 0) this.winLeg();
                }
            },
            handleCricket: function(points, mul, label) {
                let seg = 0;
                if(label.includes('Bull')) seg = 25;
                else if(points > 0) seg = points / mul;

                this.turn.dartsThrown++;
                this.turn.history.push(label);
                this.turn.darts.push(label.split(' ')[0][0] + seg); 

                if([20,19,18,17,16,15,25].includes(seg)) {
                    const p = this.currentPlayer;
                    const hits = this.cricket[p][seg];
                    let scoreToAdd = 0;
                    let newHits = hits + mul;
                    
                    let canScore = false;
                    
                    if(hits < 3) {
                        if(newHits > 3) {
                            const othersOpen = this.cricket.some((c, i) => i !== p && c[seg] < 3);
                            if(othersOpen) scoreToAdd = (newHits - 3) * seg;
                            this.cricket[p][seg] = 3; 
                        } else {
                            this.cricket[p][seg] = newHits;
                        }
                    } else {
                        const othersOpen = this.cricket.some((c, i) => i !== p && c[seg] < 3);
                        if(othersOpen) scoreToAdd = mul * seg;
                    }
                    
                    if(scoreToAdd > 0) {
                        this.scores[p] += scoreToAdd;
                        this.turn.score += scoreToAdd;
                        this.logAction(`${this.pName()} Scored ${scoreToAdd} on ${seg==25?'Bull':seg}`);
                    } else {
                        this.logAction(`${this.pName()} Hit ${label}`);
                    }
                    
                    this.playerStats[p].totalScore += scoreToAdd; 
                    this.playerStats[p].totalDarts++;

                    const allClosed = [20,19,18,17,16,15,25].every(k => this.cricket[p][k] >= 3);
                    const myScore = this.scores[p];
                    const highestOpponent = Math.max(...this.scores.filter((s, i) => i !== p));
                    
                    if(allClosed && myScore >= highestOpponent) this.winLeg();

                } else {
                    this.logAction(`${this.pName()} Miss/Null`);
                    this.playerStats[this.currentPlayer].totalDarts++;
                }
            },
            handleATC: function(points, mul, label) {
                const target = this.atc[this.currentPlayer];
                let seg = 0;
                if(label.includes('Bull')) seg = 25;
                else if(points > 0) seg = points / mul;

                this.turn.dartsThrown++;
                this.turn.history.push(label);
                this.turn.darts.push(points > 0 ? seg : 0);

                let hit = false;
                if(target <= 20 && seg === target) hit = true;
                else if(target === 25 && seg === 25) hit = true;

                if(hit) {
                    AudioEngine.playDouble();
                    UI.flashSegment(seg);
                    this.logAction(`${this.pName()} Hit Target ${target}!`);
                    if(target === 25) {
                        this.scores[this.currentPlayer] = "WIN";
                        this.winLeg();
                    } else {
                        this.atc[this.currentPlayer] = (target === 20) ? 25 : target + 1;
                        this.scores[this.currentPlayer] = this.atc[this.currentPlayer] === 25 ? "BULL" : this.atc[this.currentPlayer];
                    }
                } else {
                    this.logAction(`${this.pName()} Missed Target ${target}`);
                }
                this.playerStats[this.currentPlayer].totalDarts++;
            },
            pName: function() { return this.matchConfig.playerNames[this.currentPlayer]; },
            saveState: function() { 
                this.historyStack.push(JSON.parse(JSON.stringify({ 
                    s: this.scores, c: this.currentPlayer, t: this.turn, l: this.legs, 
                    log: this.gameLog, crick: this.cricket, atc: this.atc, stats: this.playerStats 
                }))); 
            },
            undo: function() {
                if(this.historyStack.length === 0) return;
                const st = this.historyStack.pop();
                this.scores = st.s; this.currentPlayer = st.c; this.turn = st.t; this.legs = st.l; this.gameLog = st.log;
                if(st.crick) this.cricket = st.crick;
                if(st.atc) this.atc = st.atc;
                if(st.stats) this.playerStats = st.stats;
                
                document.querySelectorAll('.hit-marker').forEach(e => e.remove());
                if(this.turn.markers) {
                    this.turn.markers.forEach(m => UI.drawMarker(m.x, m.y, this.currentPlayer));
                }

                UI.render(); UI.renderLog(); AudioEngine.speak("Undo");
                this.persist();
            },
            manualEditScore: function() {
                App.closeSettings();
                const current = this.scores[this.currentPlayer];
                const input = prompt(`Edit ${this.pName()} Score/Target.\nCurrent: ${current}`, current);
                if(input !== null) {
                    const val = parseInt(input);
                    if(val || val === 0) {
                        this.saveState();
                        this.scores[this.currentPlayer] = val;
                        if(this.mode === 'atc') this.atc[this.currentPlayer] = val;
                        this.turn.dartsThrown = 0; this.turn.score = 0; this.turn.history = []; this.turn.darts = [];
                        this.resetTurn(); 
                        this.logAction(`Manual Edit: ${this.pName()} set to ${val}`);
                        UI.render();
                        this.persist();
                    }
                }
            },
            logAction: function(msg) { this.gameLog.push(msg); UI.renderLog(); },
            winLeg: function() {
                this.turn.won = true; this.legs[this.currentPlayer]++;
                UI.render(); 
                AudioEngine.playWin(); Confetti.start();
                AudioEngine.speak("Game Shot");
                this.stopMic();
                setTimeout(() => {
                    document.getElementById('winner-name').textContent = `${this.pName()} Wins!`;
                    document.getElementById('winner-modal').classList.remove('hidden');
                    document.getElementById('winner-modal').classList.add('flex');
                }, 1500);
                this.persist();
            },
            nextTurn: function() {
                // Cycle player: (current + 1) % count
                this.currentPlayer = (this.currentPlayer + 1) % this.matchConfig.playerCount;
                this.resetTurn(); 
                UI.render();
                if(this.micMode === 'turn' && !this.isListening) this.startMic();
                this.persist();
            },
            inputDigit: function(d) {
                this.inputBuffer += d; 
                document.getElementById('mob-input-display').textContent = this.inputBuffer;
            },
            clearInput: function() { 
                this.inputBuffer = ''; 
                document.getElementById('mob-input-display').textContent = 'Enter score'; 
            },
            submitInputBuffer: function() {
                const val = parseInt(this.inputBuffer);
                if(!isNaN(val)) {
                    let mul = 1; let lbl = "Single " + val;
                    if(val === 50) { mul=2; lbl="Bullseye"; }
                    else if(val === 25) { mul=1; lbl="Outer Bull"; }
                    else if(val > 60) { mul=3; lbl="Total " + val; }
                    
                    if((val > 60 || this.turn.dartsThrown === 0) && this.mode === 'x01') {
                        this.processThrow(val, mul, lbl, null);
                        if(this.turn.dartsThrown < 3) { this.turn.dartsThrown = 3; setTimeout(() => this.nextTurn(), 1000); }
                    } else {
                        this.processThrow(val, mul, lbl, null);
                    }
                }
                this.clearInput();
            },
            setStartScore: function(s) { this.init(s); },
            initMic: function() {
                if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SR();
                this.recognition.continuous = false; this.recognition.lang = 'en-US'; this.recognition.interimResults = false;
                this.recognition.onstart = () => { this.isListening = true; UI.updateMicUI(true, this.micMode); };
                this.recognition.onend = () => { 
                    this.isListening = false; UI.updateMicUI(false, this.micMode);
                    if(this.micMode === 'always' && !this.turn.won) this.startMic();
                    else if(this.micMode === 'turn' && !this.turn.won && this.turn.dartsThrown < 3) this.startMic();
                    else if(this.micMode === 'single') this.micMode = 'off';
                };
                this.recognition.onresult = (e) => {
                     const t = e.results[0][0].transcript; console.log("Heard:", t); this.parseVoice(t);
                };
            },
            setMicMode: function(m) {
                if(!this.recognition) return;
                if(this.isListening && this.micMode === m) { this.stopMic(); return; }
                this.micMode = m; if(this.isListening) this.recognition.stop();
                setTimeout(() => this.startMic(), 100);
            },
            cycleMicMode: function() {
                const modes = ['off', 'single', 'turn', 'always'];
                const currentIdx = modes.indexOf(this.micMode);
                const nextMode = modes[(currentIdx + 1) % modes.length];
                this.setMicMode(nextMode);
            },
            startMic: function() { if(!this.isListening && this.recognition) try{this.recognition.start()}catch(e){} },
            stopMic: function() { this.micMode = 'off'; if(this.recognition) this.recognition.stop(); },
            
            // Hold to Speak Logic
            startHold: function() {
                if(this.isListening) return;
                this.micMode = 'hold';
                this.startMic();
            },
            stopHold: function() {
                this.stopMic();
            },

            parseVoice: function(text) {
                const lower = text.toLowerCase().replace(/[.,-]/g,' ').replace(/\s+/g,' ').trim();
                if (lower.includes('undo') || lower.includes('go back')) { this.undo(); return; }
                if (lower.includes('next turn') || lower.includes('switch')) { this.nextTurn(); return; }
                if (lower.includes('score')) { AudioEngine.speak(`${this.scores[this.currentPlayer]} remaining`); return; }
                if (lower.includes('correction')) { this.undo(); return; }

                const words = lower.split(' ');
                let i=0;
                const getNum = (w) => {
                    if(!w)return null; if(w==='one'||w==='won')return 1; if(w==='two'||w==='to'||w==='too')return 2;
                    if(w==='three')return 3; if(w==='four'||w==='for')return 4; if(w==='five')return 5;
                    if(w==='six')return 6; if(w==='seven')return 7; if(w==='eight')return 8; if(w==='nine')return 9;
                    if(w==='ten')return 10; if(w==='eleven')return 11; if(w==='twelve')return 12;
                    if(w==='twenty')return 20; const n=parseInt(w); return isNaN(n)?null:n;
                };
                while(i < words.length) {
                    if(this.turn.dartsThrown>=3 || this.turn.won) break;
                    const w = words[i];
                    if(w.includes('bull')) {
                        if(w==='outer') { this.processThrow(25,1,"Outer Bull", null); i+=2; }
                        else { this.processThrow(50,2,"Bullseye", null); i++; }
                        continue;
                    }
                    let m=1, p="Single", v=null;
                    if(w==='single') { m=1; i++; }
                    else if(w==='double') { m=2; p="Double"; i++; }
                    else if(w==='triple'||w==='treble') { m=3; p="Triple"; i++; }
                    
                    if(i<words.length) {
                        if(words[i]==='twenty' && words[i+1]==='five') { v=25; i+=2; }
                        else { v=getNum(words[i]); i++; }
                    }
                    if(v!==null) {
                        if(v===25 && m===1) this.processThrow(25,1,"Outer Bull", null);
                        else if(v>=0 && v<=20) this.processThrow(v*m, m, `${p} ${v}`, null);
                    } else if(m===1 && v===null && !w.includes('bull')) i++;
                }
            },
            persist: function() {
                try {
                    const data = {
                        scores: this.scores, legs: this.legs, currentPlayer: this.currentPlayer,
                        turn: this.turn, gameLog: this.gameLog, cricket: this.cricket, atc: this.atc,
                        mode: this.mode, playerStats: this.playerStats, matchConfig: this.matchConfig
                    };
                    localStorage.setItem('dartsOS_v1', JSON.stringify(data));
                } catch(e) { console.error("Save failed", e); }
            },
            loadGame: function() {
                try {
                    const data = JSON.parse(localStorage.getItem('dartsOS_v1'));
                    if(data) {
                        this.scores = data.scores; this.legs = data.legs; this.currentPlayer = data.currentPlayer;
                        this.turn = data.turn; this.gameLog = data.gameLog; this.cricket = data.cricket;
                        this.atc = data.atc; this.mode = data.mode; 
                        if(data.playerStats) this.playerStats = data.playerStats;
                        if(data.matchConfig) this.matchConfig = data.matchConfig;
                        
                        // Set inputs
                        document.getElementById('set-legs').value = this.matchConfig.legsToWin;
                        document.getElementById('dash-player-count').textContent = this.matchConfig.playerCount;
                        
                        document.querySelectorAll('.hit-marker').forEach(e => e.remove());
                        if(this.turn.markers) {
                            this.turn.markers.forEach(m => UI.drawMarker(m.x, m.y, this.currentPlayer));
                        }
                        
                        UI.render(); UI.renderLog();
                        App.setView('game');
                    }
                } catch(e) { console.error("Load failed", e); }
            }
        };

        const UI = {
            render: function() {
                const p = Game.currentPlayer;
                const score = Game.scores[p];
                let displayScore = score;
                if(Game.mode === 'atc') displayScore = (score===25||score==="BULL") ? "BULL" : score;

                // Mobile Updates
                const card = document.getElementById('mob-active-card');
                card.style.background = PlayerColors[p];
                card.style.borderColor = 'rgba(255,255,255,0.4)';
                document.getElementById('mob-p-num').textContent = p + 1;
                document.getElementById('mob-p-name').textContent = Game.matchConfig.playerNames[p];
                
                this.animateValue('mob-score', displayScore);
                document.getElementById('mob-score').style.fontSize = (typeof(displayScore)==='string' && displayScore.length>3) ? "3.5rem" : "5.5rem";
                document.getElementById('mob-legs').textContent = `Legs: ${Game.legs[p]}`;
                document.getElementById('mob-darts').textContent = Game.turn.dartsThrown;
                document.getElementById('mob-last').textContent = Game.turn.history.length > 0 ? Game.turn.history[Game.turn.history.length-1] : '-';
                
                let suggestion = "-";
                if(Game.mode === 'x01') suggestion = this.getCheckout(score) || "Score High";
                else if(Game.mode === 'atc') suggestion = `Target: ${score}`;
                else if(Game.mode === 'cricket') suggestion = "Close 20-15 & Bull";
                document.getElementById('mob-suggestion').textContent = suggestion;
                
                // Mobile Cricket Grid - Only shows active player
                const mobGrid = document.getElementById('mob-cricket-grid');
                if(Game.mode === 'cricket') {
                    mobGrid.style.display = 'flex';
                    let html = `<div class="cricket-row text-white/50 border-b border-white/10 pb-1">`;
                    [20,19,18,17,16,15,25].forEach(k => html += `<span>${k===25?'B':k}</span>`);
                    html += `</div><div class="cricket-row font-bold text-lg">`;
                    [20,19,18,17,16,15,25].forEach(k => {
                        const hits = Game.cricket[p][k];
                        const animClass = hits >= 3 ? 'anim-stamp' : '';
                        html += `<span class="${animClass}">${hits>=3 ? '‚¨§' : (hits===2 ? '‚ï≥' : (hits===1 ? '‚üã' : '¬∑'))}</span>`;
                    });
                    html += `</div>`;
                    mobGrid.innerHTML = html;
                } else {
                    mobGrid.style.display = 'none';
                }

                // Darts display
                const mobDartsHtml = Game.turn.darts.length > 0 ? 
                    Game.turn.darts.map(d => `<div class="bg-white/20 rounded px-2 py-0.5 min-w-[2rem] text-center inline-flex items-center justify-center anim-pop">${d}</div>`).join('') : '<span class="opacity-50">0</span>';
                document.getElementById('mob-turn-score').innerHTML = mobDartsHtml;

                // Desktop Updates - Dynamic Player List
                const deskList = document.getElementById('desktop-player-list');
                deskList.innerHTML = '';
                
                // Safety check: iterate based on count, not array length if mismatched
                for(let idx = 0; idx < Game.matchConfig.playerCount; idx++) {
                    const name = Game.matchConfig.playerNames[idx];
                    const isActive = idx === p;
                    const pScore = Game.scores[idx];
                    let dScore = pScore;
                    if(Game.mode === 'atc') dScore = (pScore===25||pScore==="BULL") ? "BULL" : pScore;
                    
                    const card = document.createElement('div');
                    card.className = `glass-panel rounded-2xl p-6 flex flex-col justify-between min-h-[160px] transition-all duration-300 relative overflow-hidden group ${isActive ? 'ring-2 opacity-100' : 'opacity-50'}`;
                    if(isActive) {
                        card.style.background = `${PlayerColors[idx]}33`; // 20% opacity
                        card.style.borderColor = PlayerColors[idx];
                    }
                    
                    let cricketHtml = '';
                    if(Game.mode === 'cricket') {
                        cricketHtml = `<div class="grid grid-cols-7 gap-1 mt-2 mb-2 relative z-10 text-center text-xs">`;
                        [20,19,18,17,16,15,25].forEach(k => {
                            const h = Game.cricket[idx][k];
                            const sym = h>=3 ? '‚¨§' : (h===2 ? '‚ï≥' : (h===1 ? '‚üã' : '¬∑'));
                            const col = h>=3 ? 'text-green-400' : 'text-slate-500';
                            cricketHtml += `<div class="flex flex-col"><span class="opacity-50">${k===25?'B':k}</span><span class="font-bold ${col}">${sym}</span></div>`;
                        });
                        cricketHtml += `</div>`;
                    }

                    // Checkout Suggestion (only for active player)
                    let checkHtml = '';
                    if(isActive && Game.mode === 'x01') {
                        const sug = this.getCheckout(pScore);
                        if(sug) checkHtml = `<div class="text-right"><div class="text-amber-400 font-mono font-bold text-lg animate-pulse">${sug}</div><div class="text-[10px] uppercase text-slate-400 font-bold tracking-widest">Checkout</div></div>`;
                    }

                    card.innerHTML = `
                        <div class="absolute top-[-10px] right-[-10px] opacity-10 text-8xl font-black select-none z-0">${idx+1}</div>
                        <div class="flex justify-between items-start relative z-10">
                            <h2 class="font-bold text-slate-200 text-lg uppercase tracking-widest flex items-center group">
                                ${name}
                                <button onclick="App.openSettings()" class="ml-2 opacity-0 group-hover:opacity-100 transition text-sm" title="Edit Names">‚úèÔ∏è</button>
                            </h2>
                            <div class="text-xs font-mono font-bold text-slate-400">LEGS <span class="text-white bg-slate-800 px-2 py-1 rounded">${Game.legs[idx]}</span></div>
                        </div>
                        ${cricketHtml}
                        <div class="flex justify-between items-end mt-2 relative z-10">
                            <div class="text-6xl font-black font-mono tracking-tighter text-white">${dScore}</div>
                            ${checkHtml}
                        </div>
                    `;
                    deskList.appendChild(card);
                }

                document.getElementById('desk-status').textContent = `${Game.matchConfig.playerNames[p]}'s Turn`;
                
                const deskDartsHtml = Game.turn.darts.length > 0 ? 
                    Game.turn.darts.map(d => `<div class="bg-white/10 rounded-lg px-3 py-1 min-w-[3rem] text-center border border-white/5 shadow-inner text-2xl inline-flex items-center justify-center anim-pop">${d}</div>`).join('') : '<span class="opacity-50 text-2xl">0</span>';
                document.getElementById('desk-turn-total').innerHTML = deskDartsHtml;

                // Highlights
                document.querySelectorAll('.segment-highlight, .highlight-p1, .highlight-p2, .highlight-p3, .highlight-p4, .highlight-p5, .highlight-p6').forEach(el => {
                    el.classList.remove('segment-highlight', 'highlight-p1', 'highlight-p2', 'highlight-p3', 'highlight-p4', 'highlight-p5', 'highlight-p6');
                });

                if(Game.mode === 'x01' && this.getCheckout(score)) this.highlightCheckout(this.getCheckout(score));
                if(Game.mode === 'atc') this.highlightNumber(Game.atc[p]);
                
                // Update Settings Inputs if modal open
                if(!document.getElementById('settings-modal').classList.contains('hidden')) this.renderSettingsInputs();
                
                // Update Header Mic UI
                this.updateMicUI(Game.micMode !== 'off', Game.micMode);
            },
            renderLog: function() {
                const rev = [...Game.gameLog].reverse();
                const mkLog = (arr) => arr.map(l => `<div class="py-1 border-b border-white/5">${l}</div>`).join('');
                
                const deskLog = document.getElementById('desktop-game-log');
                if(deskLog) deskLog.innerHTML = mkLog(rev);
                
                const mobLog = document.getElementById('mobile-game-log');
                if(mobLog) mobLog.innerHTML = mkLog(rev);
            },
            drawMarker: function(x, y, player) {
                const m = document.createElement('div');
                m.className = `hit-marker anim p${player+1}`;
                m.style.left = x + 'px';
                m.style.top = y + 'px';
                document.body.appendChild(m);
            },
            updateSettingsUI: function() {
                const doBtn = document.getElementById('btn-do');
                const soBtn = document.getElementById('btn-so');
                if(Game.matchConfig.doubleOut) {
                    doBtn.classList.remove('bg-slate-700'); doBtn.classList.add('bg-indigo-600');
                    soBtn.classList.remove('bg-indigo-600'); soBtn.classList.add('bg-slate-700');
                } else {
                    doBtn.classList.remove('bg-indigo-600'); doBtn.classList.add('bg-slate-700');
                    soBtn.classList.remove('bg-slate-700'); soBtn.classList.add('bg-indigo-600');
                }
                this.renderSettingsInputs();
            },
            renderSettingsInputs: function() {
                const container = document.getElementById('settings-player-inputs');
                container.innerHTML = '';
                Game.matchConfig.playerNames.forEach((name, idx) => {
                    const div = document.createElement('div');
                    div.className = "flex gap-2";
                    div.innerHTML = `<div class="w-8 h-10 flex items-center justify-center font-bold bg-white/5 rounded text-slate-400">${idx+1}</div>
                                     <input type="text" value="${name}" class="flex-grow bg-slate-800/50 border border-slate-600 rounded p-2 text-white" onchange="Game.updatePlayerName(${idx}, this.value)">`;
                    container.appendChild(div);
                });
            },
            updateMicUI: function(active, mode) {
                const btnDesk = document.getElementById('btn-mic-header-desk');
                const lblDesk = document.getElementById('lbl-mic-header-desk');
                const btnMob = document.getElementById('btn-mic-header-mob');
                
                let text = "OFF";
                let colorClass = "text-slate-400";
                
                if (mode === 'single') { text = "SINGLE"; colorClass = "text-blue-400"; }
                else if (mode === 'turn') { text = "TURN"; colorClass = "text-orange-400"; }
                else if (mode === 'always') { text = "ALWAYS"; colorClass = "text-red-400"; }
                
                // Clear old colors
                const colors = ["text-slate-400", "text-blue-400", "text-orange-400", "text-red-400"];
                btnDesk.classList.remove(...colors);
                btnMob.classList.remove(...colors);
                
                // Set new state
                btnDesk.classList.add(colorClass);
                btnMob.classList.add(colorClass);
                lblDesk.textContent = text;
            },
            renderStats: function() {
                const container = document.getElementById('stats-container');
                let html = `<table class="w-full text-left border-collapse"><thead><tr><th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10">Player</th>
                            <th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10 text-center">Avg</th>
                            <th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10 text-center">Checkout</th>
                            <th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10 text-center">100+</th>
                            <th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10 text-center">140+</th>
                            <th class="p-3 text-slate-400 text-xs uppercase border-b border-white/10 text-center">180</th></tr></thead><tbody>`;
                
                Game.playerStats.forEach((s, idx) => {
                    const avg = s.totalDarts > 0 ? ((s.totalScore / s.totalDarts) * 3).toFixed(2) : "0.00";
                    const co = s.checkoutAttempts > 0 ? ((s.checkoutHits / s.checkoutAttempts) * 100).toFixed(0) + "%" : "-";
                    html += `<tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-3 font-bold text-white">${Game.matchConfig.playerNames[idx]}</td>
                        <td class="p-3 text-center font-mono text-cyan-400">${avg}</td>
                        <td class="p-3 text-center font-mono text-emerald-400">${co}</td>
                        <td class="p-3 text-center font-mono text-slate-300">${s.s100}</td>
                        <td class="p-3 text-center font-mono text-slate-300">${s.s140}</td>
                        <td class="p-3 text-center font-mono text-amber-400 font-bold">${s.s180}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },
            getCheckout: function(s) {
                if (s > 170 || s < 2) return "";
                const c = {
                    170: "T20 T20 Bull", 167: "T20 T19 Bull", 164: "T20 T18 Bull", 161: "T20 T17 Bull", 160: "T20 T20 D20",
                    158: "T20 T20 D19", 157: "T20 T19 D20", 156: "T20 T20 D18", 155: "T20 T19 D19", 154: "T20 T18 D20",
                    153: "T20 T19 D18", 152: "T20 T20 D16", 151: "T20 T17 D20", 150: "T20 T18 D18", 149: "T20 T19 D16",
                    148: "T20 T16 D20", 147: "T20 T17 D18", 146: "T20 T18 D16", 145: "T20 T15 D20", 144: "T20 T20 D12",
                    143: "T20 T17 D16", 142: "T20 T14 D20", 141: "T20 T19 D12", 140: "T20 T16 D16", 139: "T20 T13 D20",
                    138: "T20 T18 D12", 137: "T19 T16 D16", 136: "T20 T20 D8", 135: "T20 T17 D12", 134: "T20 T14 D16",
                    133: "T20 T19 D8", 132: "T20 T20 D6", 131: "T20 T13 D16", 130: "T20 T18 D8", 129: "T19 T16 D12",
                    128: "T18 T14 D16", 127: "T20 T17 D8", 126: "T19 T19 D6", 125: "Bull T20 D20", 124: "T20 T16 D8",
                    123: "T19 T16 D9", 122: "T18 T20 D4", 121: "T20 T15 D8", 120: "T20 20 D20", 119: "T19 T10 D16",
                    118: "T20 18 D20", 117: "T20 17 D20", 116: "T20 16 D20", 115: "T20 15 D20", 114: "T20 14 D20",
                    113: "T20 13 D20", 112: "T20 12 D20", 111: "T20 19 D16", 110: "T20 10 D20", 109: "T20 17 D16",
                    108: "T20 16 D16", 107: "T19 10 D20", 106: "T20 14 D16", 105: "T20 13 D16", 104: "T18 10 D20",
                    103: "T20 3 D20", 102: "T20 10 D16", 101: "T17 10 D20", 100: "T20 D20", 99: "T19 10 D16",
                    98: "T20 D19", 97: "T19 D20", 96: "T20 D18", 95: "T19 D19", 94: "T18 D20",
                    93: "T19 D18", 92: "T20 D16", 91: "T17 D20", 90: "T18 D18", 89: "T19 D16",
                    88: "T16 D20", 87: "T17 D18", 86: "T18 D16", 85: "T15 D20", 84: "T20 D12",
                    83: "T17 D16", 82: "T14 D20", 81: "T15 D18", 80: "T20 D10", 79: "T13 D20",
                    78: "T18 D12", 77: "T19 D10", 76: "T20 D8", 75: "T17 D12", 74: "T14 D16",
                    73: "T19 D8", 72: "T16 D12", 71: "T13 D16", 70: "T18 D8", 69: "T15 D12",
                    68: "T20 D4", 67: "T17 D8", 66: "T10 D18", 65: "T19 D4", 64: "T16 D8",
                    63: "T13 D12", 62: "T10 D16", 61: "T15 D8", 60: "20 D20", 59: "19 D20",
                    58: "18 D20", 57: "17 D20", 56: "16 D20", 55: "15 D20", 54: "14 D20",
                    53: "13 D20", 52: "12 D20", 51: "11 D20", 50: "Bull", 49: "9 D20",
                    48: "16 D16", 47: "7 D20", 46: "6 D20", 45: "13 D16", 44: "4 D20",
                    43: "3 D20", 42: "6 D18", 41: "9 D16", 40: "D20", 39: "7 D16",
                    38: "D19", 37: "5 D16", 36: "D18", 35: "3 D16", 34: "D17",
                    33: "1 D16", 32: "D16", 31: "15 D8", 30: "D15", 29: "13 D8",
                    28: "D14", 27: "11 D8", 26: "D13", 25: "9 D8", 24: "D12",
                    23: "7 D8", 22: "D11", 21: "5 D8", 20: "D10", 19: "3 D8",
                    18: "D9", 17: "1 D8", 16: "D8", 15: "7 D4", 14: "D7",
                    13: "5 D4", 12: "D6", 11: "3 D4", 10: "D5", 9: "1 D4",
                    8: "D4", 7: "3 D2", 6: "D3", 5: "1 D2", 4: "D2",
                    3: "1 D1", 2: "D1"
                };
                return c[s] || "";
            },
            highlightCheckout: function(str) {
                const cls = 'segment-highlight'; 
                let target = str.split(' ')[0]; let id = "";
                if(target.startsWith('T')) id = `segment-t-${target.substring(1)}`;
                else if(target.startsWith('D')) id = `segment-d-${target.substring(1)}`;
                else if(target === 'Bull') id = 'segment-50'; else if(target === '25') id = 'segment-25'; else if(!isNaN(target)) id = `segment-s-${target}`;
                if(id) { const sel = `[id="${id}"]`; document.querySelectorAll(sel).forEach(el => el.classList.add(cls)); }
            },
            highlightNumber: function(num) {
                const cls = `highlight-p${Game.currentPlayer+1}`;
                if(num === 25) {
                    ['segment-25', 'segment-50'].forEach(id => {
                        const el = document.querySelectorAll(`[id="${id}"]`);
                        el.forEach(e => e.classList.add(cls));
                    });
                } else if (num >= 1 && num <= 20) {
                     ['s', 'si', 'd', 't'].forEach(type => {
                        const id = `segment-${type}-${num}`;
                        const el = document.querySelectorAll(`[id="${id}"]`);
                        el.forEach(e => e.classList.add(cls));
                     });
                }
            },
            animateValue: function(id, end) {
                const obj = document.getElementById(id);
                if(!obj) return;
                if(isNaN(parseInt(end))) { obj.textContent = end; return; }
                const start = parseInt(obj.textContent);
                if(start === end || isNaN(start)) { obj.textContent = end; return; }
                const range = end - start;
                const minTimer = 50;
                let stepTime = Math.abs(Math.floor(500 / range));
                stepTime = Math.max(stepTime, minTimer);
                const startTime = new Date().getTime();
                const endTime = startTime + 500;
                let timer;
                const run = () => {
                    const now = new Date().getTime();
                    const remaining = Math.max((endTime - now) / 500, 0);
                    const value = Math.round(end - (remaining * range));
                    obj.textContent = value;
                    if (value == end) { clearInterval(timer); }
                };
                timer = setInterval(run, stepTime);
                run();
            },
            flashCheckout: function(points, mul) {
                let ids = [];
                if(points === 50 && mul === 2) ids.push('segment-50');
                else if(points === 25 && mul === 1) ids.push('segment-25');
                else if(mul === 2) ids.push(`segment-d-${points/2}`);
                else if(mul === 3) ids.push(`segment-t-${points/3}`);
                else if(mul === 1) {
                    ids.push(`segment-s-${points}`);
                    ids.push(`segment-si-${points}`);
                }
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.classList.remove('anim-checkout');
                        void el.offsetWidth;
                        el.classList.add('anim-checkout');
                    }
                });
            },
            flashSegment: function(num) {
                 if (num >= 1 && num <= 20) {
                     ['s', 'si', 'd', 't'].forEach(type => {
                        const id = `segment-${type}-${num}`;
                        const el = document.querySelectorAll(`[id="${id}"]`);
                        el.forEach(e => { e.classList.remove('anim-flash'); void e.offsetWidth; e.classList.add('anim-flash'); });
                     });
                } else if(num === 25) {
                    ['segment-25', 'segment-50'].forEach(id => {
                         const el = document.querySelectorAll(`[id="${id}"]`);
                         el.forEach(e => { e.classList.remove('anim-flash'); void e.offsetWidth; e.classList.add('anim-flash'); });
                    });
                }
            }
        };

        const App = {
            updatePlayerCount: function(delta) {
                let c = Game.matchConfig.playerCount + delta;
                if(c < 1) c = 1;
                if(c > 6) c = 6;
                Game.matchConfig.playerCount = c;
                document.getElementById('dash-player-count').textContent = c;
                // Re-init defaults for names
                while(Game.matchConfig.playerNames.length < c) {
                    Game.matchConfig.playerNames.push(`Player ${Game.matchConfig.playerNames.length+1}`);
                }
            },
            openSettings: function() { 
                document.getElementById('settings-modal').classList.remove('hidden'); 
                document.getElementById('settings-modal').classList.add('flex');
                UI.updateSettingsUI();
            },
            closeSettings: function() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); },
            toggleMobileLog: function() {
                const el = document.getElementById('mobile-log-modal');
                if(el.classList.contains('hidden')) { el.classList.remove('hidden'); el.classList.add('flex'); } else { el.classList.add('hidden'); el.classList.remove('flex'); }
            },
            toggleStats: function() {
                const el = document.getElementById('stats-modal');
                if(el.classList.contains('hidden')) { 
                    UI.renderStats();
                    el.classList.remove('hidden'); el.classList.add('flex'); 
                } else { 
                    el.classList.add('hidden'); el.classList.remove('flex'); 
                }
            },
            toggleInfo: function() {
                const el = document.getElementById('info-modal');
                if(el.classList.contains('hidden')) { 
                    el.classList.remove('hidden'); el.classList.add('flex'); 
                } else { 
                    el.classList.add('hidden'); el.classList.remove('flex'); 
                }
            },
            setMobileTab: function(tab) {
                document.querySelectorAll('.mobile-tab-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`mob-tab-${tab}`).classList.add('active');
                const btnK = document.getElementById('tab-btn-keypad'), btnB = document.getElementById('tab-btn-board'), btnV = document.getElementById('tab-btn-voice');
                [btnK, btnB, btnV].forEach(b => { if(b) { b.classList.remove('bg-white/10', 'text-white'); b.classList.add('text-slate-400'); } });
                const activeBtn = document.getElementById(`tab-btn-${tab}`);
                if(activeBtn) { activeBtn.classList.add('bg-white/10', 'text-white'); activeBtn.classList.remove('text-slate-400'); }
            },
            setView: function(v) {
                document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-game-mobile').classList.add('hidden');
                document.getElementById('view-game-desktop').classList.remove('flex'); document.getElementById('view-game-desktop').classList.add('hidden');
                if(v === 'dashboard') {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    if(localStorage.getItem('dartsOS_v1')) document.getElementById('resume-btn').classList.remove('hidden');
                }
                else {
                    if(window.innerWidth < 1024) { document.getElementById('view-game-mobile').classList.remove('hidden'); document.getElementById('view-game-mobile').classList.add('flex'); }
                    else { document.getElementById('view-game-desktop').classList.remove('hidden'); document.getElementById('view-game-desktop').classList.add('flex'); }
                }
            },
            startGame: function(mode) { this.setView('game'); Game.init(mode, true); }
        };

        window.addEventListener('load', () => {
            Dartboard.create('desk-board-container', 'dartboard-desk'); Dartboard.create('mob-board-container', 'dartboard-mob');
            App.setView('dashboard');

            // Setup Hold to Speak Button
            const holdBtn = document.getElementById('btn-hold-speak');
            if(holdBtn) {
                const start = (e) => { 
                    e.preventDefault(); 
                    Game.startHold(); 
                    holdBtn.classList.remove('bg-indigo-600', 'border-indigo-400');
                    holdBtn.classList.add('bg-red-600', 'border-red-400');
                    holdBtn.innerHTML = "<span>üéôÔ∏è</span> LISTENING...";
                };
                const end = (e) => { 
                    e.preventDefault(); 
                    Game.stopHold(); 
                    holdBtn.classList.add('bg-indigo-600', 'border-indigo-400');
                    holdBtn.classList.remove('bg-red-600', 'border-red-400');
                    holdBtn.innerHTML = "<span>üéôÔ∏è</span> HOLD TO SPEAK";
                };
                
                holdBtn.addEventListener('touchstart', start, {passive: false});
                holdBtn.addEventListener('touchend', end, {passive: false});
                holdBtn.addEventListener('mousedown', start);
                holdBtn.addEventListener('mouseup', end);
                holdBtn.addEventListener('mouseleave', end);
            }
        });

        const TouchZoom = {
            timer: null, magnifier: document.getElementById('magnifier'), active: false,
            start: function(e, boardId) { this.active = true; this.timer = setTimeout(() => this.show(e, boardId), 200); },
            move: function(e, boardId) { if(this.active && this.magnifier.style.display === 'block') this.update(e, boardId); },
            end: function(e) { 
                clearTimeout(this.timer); this.active = false; this.magnifier.style.display = 'none';
                if (this.magnifier.style.display === 'block' || document.querySelector('.hover-highlight')) {
                    const touch = e.changedTouches[0]; const el = document.elementFromPoint(touch.clientX, touch.clientY);
                    document.querySelectorAll('.hover-highlight').forEach(x => x.classList.remove('hover-highlight'));
                    if(el && el.classList.contains('dartboard-segment')) el.dispatchEvent(new MouseEvent('click', { 'view': window, 'bubbles': true, 'cancelable': true }));
                }
            },
            show: function(e, boardId) {
                this.magnifier.style.display = 'block'; const originalSvg = document.getElementById(boardId);
                this.magnifier.innerHTML = ''; const clone = originalSvg.cloneNode(true);
                clone.removeAttribute('id'); clone.style.width = '100%'; clone.style.height = '100%';
                this.magnifier.appendChild(clone); this.update(e, boardId);
            },
            update: function(e, boardId) {
                const touch = e.touches[0] || e.changedTouches[0]; 
                const rect = document.getElementById(boardId).getBoundingClientRect();
                
                // Magnifier Dimensions (140px width/height defined in CSS)
                const magSize = 140; 
                const halfMag = magSize / 2;

                // Smart Clamping: Keep magnifier fully on screen
                // We calculate where the center 'left' and 'top' should be
                let safeLeft = touch.clientX;
                let safeTop = touch.clientY - 60; // Default offset

                // Clamp Horizontal (Prevent going off left or right edges)
                // Since css has transform: translate(-50%), the visual edges are left-70 and left+70
                if (safeLeft < halfMag) safeLeft = halfMag;
                if (safeLeft > window.innerWidth - halfMag) safeLeft = window.innerWidth - halfMag;

                // Clamp Vertical (Prevent going off top)
                // CSS has transform: translate(..., -130%). Height is 140. 
                // Visual top is top - (140 * 1.3) = top - 182.
                // We want visual top >= 0. So top >= 182.
                // However, usually touching top of board is fine, but let's clamp just in case.
                // Let's just clamp the box itself not to go too wild. 
                // Actually, standard behavior is usually fine vertically unless right at the top.
                // Let's stick to Horizontal clamping which is the main issue for D6/D11.

                this.magnifier.style.left = safeLeft + 'px'; 
                this.magnifier.style.top = safeTop + 'px'; 
                
                const svg = this.magnifier.querySelector('svg');
                // Calculate percentage relative to the BOARD, not the screen
                const perX = (touch.clientX - rect.left) / rect.width; 
                const perY = (touch.clientY - rect.top) / rect.height;
                
                if (svg) { 
                    // This keeps the zoom focused exactly on the finger, even if the glass has shifted due to clamping
                    svg.style.transformOrigin = `${perX * 100}% ${perY * 100}%`; 
                    svg.style.transform = 'scale(3)'; 
                }
                
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                document.querySelectorAll('.hover-highlight').forEach(x => x.classList.remove('hover-highlight'));
                const magSvg = this.magnifier.querySelector('svg'); if(magSvg) magSvg.querySelectorAll('.hover-highlight').forEach(x => x.classList.remove('hover-highlight'));
                if(el && el.classList.contains('dartboard-segment')) {
                    el.classList.add('hover-highlight'); const id = el.getAttribute('id');
                    if (id && magSvg) { const cloneEl = magSvg.querySelector(`[id="${id}"]`); if (cloneEl) cloneEl.classList.add('hover-highlight'); }
                }
            }
        };

        const Dartboard = {
            create: function(containerId, svgId) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<svg id="${svgId}" viewBox="-220 -220 440 440" class="max-w-full max-h-full filter drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]"></svg>`;
                const svg = document.getElementById(svgId);
                svg.addEventListener('click', (e) => {
                    if (e.target === svg || !e.target.classList.contains('dartboard-segment')) {
                        Game.processThrow(0, 1, 'Miss', null);
                    }
                });
                container.addEventListener('touchstart', (e) => TouchZoom.start(e, svgId), {passive: false});
                container.addEventListener('touchmove', (e) => { e.preventDefault(); TouchZoom.move(e, svgId); }, {passive: false});
                container.addEventListener('touchend', (e) => TouchZoom.end(e), {passive: false});
                const sectors = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
                
                // Detect touch/mobile for "Fat" cells
                const isTouch = window.matchMedia("(pointer: coarse)").matches || window.innerWidth < 1024;
                
                // Dimensions: Standard vs Fat (Touch)
                // Standard: Ring width ~8 units
                // Fat: Ring width ~16 units (Double thickness for easier clicking)
                const r = isTouch 
                    ? { do: 170, di: 154, to: 107, ti: 91, bo: 22, bi: 10 } 
                    : { do: 170, di: 162, to: 107, ti: 99, bo: 16, bi: 6 };

                sectors.forEach((num, i) => {
                    const a = 360/20, s = -90-(a/2)+(i*a), e = s+a, ev = i%2===0;
                    this.arc(svg, r.to, r.di, s, e, ev?'#0f172a':'#cbd5e1', num, 1, `Single ${num}`, `segment-s-${num}`);
                    this.arc(svg, r.bo, r.ti, s, e, ev?'#0f172a':'#cbd5e1', num, 1, `Single ${num}`, `segment-si-${num}`);
                    this.arc(svg, r.di, r.do, s, e, ev?'#ef4444':'#22c55e', num, 2, `Double ${num}`, `segment-d-${num}`);
                    this.arc(svg, r.ti, r.to, s, e, ev?'#ef4444':'#22c55e', num, 3, `Triple ${num}`, `segment-t-${num}`);
                    const ta = (s+e)/2*Math.PI/180;
                    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    txt.setAttribute("x", Math.cos(ta)*195); txt.setAttribute("y", Math.sin(ta)*195);
                    txt.setAttribute("class", "dartboard-text"); txt.textContent = num; svg.appendChild(txt);
                });
                this.circ(svg, r.bo, "#22c55e", 25, "Outer Bull", "segment-25");
                this.circ(svg, r.bi, "#ef4444", 50, "Bullseye", "segment-50");
            },
            arc: function(svg, r1, r2, a1, a2, col, v, m, l, id) {
                const rad = d => d * Math.PI / 180;
                const x1=Math.cos(rad(a1))*r2, y1=Math.sin(rad(a1))*r2, x2=Math.cos(rad(a2))*r2, y2=Math.sin(rad(a2))*r2, x3=Math.cos(rad(a2))*r1, y3=Math.sin(rad(a2))*r1, x4=Math.cos(rad(a1))*r1, y4=Math.sin(rad(a1))*r1;
                const d = `M ${x1} ${y1} A ${r2} ${r2} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${r1} ${r1} 0 0 0 ${x4} ${y4} Z`;
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                p.setAttribute("d", d); p.setAttribute("fill", col); p.setAttribute("class", "dartboard-segment"); if(id) p.setAttribute("id", id);
                p.onclick = (e) => this.click(e, v*m, m, l); svg.appendChild(p);
            },
            circ: function(svg, r, col, v, l, id) {
                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("r", r); c.setAttribute("fill", col); c.setAttribute("class", "dartboard-segment"); if(id) c.setAttribute("id", id);
                c.onclick = (e) => this.click(e, v, 1, l); svg.appendChild(c);
            },
            click: function(e, pts, mul, lbl) {
                e.stopPropagation(); 
                const coords = { x: e.clientX, y: e.clientY };
                Game.turn.markers.push(coords); 
                Game.processThrow(pts, mul, lbl, coords);
            }
        };
    </script>
</body>
</html>
