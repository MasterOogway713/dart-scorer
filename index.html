<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice DartsOS Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700;800&display=swap');

        :root {
            --glass-bg: rgba(15, 23, 42, 0.9);
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-blue: #3b82f6;
            --neon-green: #10b981;
        }

        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.4), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(13, 148, 136, 0.25), transparent 25%);
            background-repeat: no-repeat;
            background-size: cover;
            color: #fff;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .player-active {
            border: 1px solid rgba(139, 92, 246, 0.6);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.15);
            z-index: 10;
        }

        .dartboard-segment { transition: all 0.1s ease; cursor: pointer; stroke: #94a3b8; stroke-width: 1px; }
        .dartboard-segment:hover { opacity: 0.9; stroke: #fff; stroke-width: 2px; filter: brightness(1.2); }
        .dartboard-text { font-family: 'JetBrains Mono'; font-weight: 800; fill: #fff; pointer-events: none; text-anchor: middle; dominant-baseline: middle; font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* Highlight checkout target */
        .segment-highlight { fill: #f59e0b !important; filter: drop-shadow(0 0 5px #f59e0b); stroke: #fff; stroke-width: 2px; animation: pulse-gold 1s infinite; }
        @keyframes pulse-gold { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-btn-active { animation: pulse-red 2s infinite; background-color: #b91c1c !important; border-color: #ef4444 !important; color: white !important; }

        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100; width: 100%; height: 100%; }
        
        .hit-marker {
            position: absolute; width: 24px; height: 24px;
            background: radial-gradient(circle, #facc15 30%, transparent 70%);
            border-radius: 50%; transform: translate(-50%, -50%);
            animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1) forwards;
            pointer-events: none; z-index: 50; box-shadow: 0 0 10px #facc15;
        }
        @keyframes ping { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }

        #virtual-keypad { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        /* 180 Animation */
        #one80-overlay { pointer-events: none; }
        .one80-text { font-size: 15vw; font-weight: 900; color: #facc15; text-shadow: 0 0 50px rgba(234, 179, 8, 0.8); animation: zoom-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes zoom-in { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
    </style>
</head>
<body class="flex flex-col h-full text-slate-200 selection:bg-purple-500 selection:text-white overflow-hidden">

    <canvas id="confetti-canvas"></canvas>
    <div id="one80-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="one80-text">180!</div></div>

    <!-- Header -->
    <header class="glass-panel sticky top-0 z-40 h-16 flex items-center justify-between px-6 border-b-0 border-b-slate-700/50 rounded-b-2xl mx-4 mt-2 shrink-0">
        <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="App.setView('dashboard')">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg shadow-purple-500/20">D</div>
            <span class="font-bold text-xl tracking-tight text-white hidden md:block">Darts<span class="text-purple-400">OS</span></span>
        </div>

        <div id="game-controls" class="flex items-center gap-2 hidden">
            <button onclick="Game.undo()" class="glass-panel px-3 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-amber-400 flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
            </button>
            <button onclick="Game.redo()" class="glass-panel px-3 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-amber-400 flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg>
            </button>
            <div class="w-[1px] h-6 bg-white/10 mx-1"></div>
            <button onclick="App.openSettings()" class="glass-panel px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 text-blue-400">‚öôÔ∏è</button>
            <button onclick="App.toggleKeypad()" class="glass-panel px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/10 border-slate-600 transition-all text-slate-200">‚å®Ô∏è</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-container" class="flex-grow relative overflow-hidden flex flex-col p-4 md:p-6 gap-6 h-full">
        
        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="w-full h-full flex flex-col items-center justify-center animate-fade-in">
            <h1 class="text-5xl md:text-7xl font-bold text-white mb-2 tracking-tight">Select Game</h1>
            <p class="text-slate-400 mb-10">Voice Controlled Scoring System</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl px-4">
                <div onclick="App.startGame('x01')" class="glass-panel p-8 rounded-3xl hover:bg-white/5 cursor-pointer transition transform hover:scale-105 border-slate-700/50 group">
                    <div class="text-6xl mb-4 group-hover:scale-110 transition">üéØ</div>
                    <h3 class="text-2xl font-bold text-white">X01</h3>
                    <p class="text-slate-400 text-sm mt-2">Classic 501 / 301. Race to zero.</p>
                </div>
                <div onclick="App.startGame('cricket')" class="glass-panel p-8 rounded-3xl hover:bg-white/5 cursor-pointer transition transform hover:scale-105 border-slate-700/50 group">
                    <div class="text-6xl mb-4 group-hover:scale-110 transition">üèè</div>
                    <h3 class="text-2xl font-bold text-white">Cricket</h3>
                    <p class="text-slate-400 text-sm mt-2">Close numbers 15-20 & Bull.</p>
                </div>
                <div onclick="App.startGame('atc')" class="glass-panel p-8 rounded-3xl hover:bg-white/5 cursor-pointer transition transform hover:scale-105 border-slate-700/50 group">
                    <div class="text-6xl mb-4 group-hover:scale-110 transition">üï∞Ô∏è</div>
                    <h3 class="text-2xl font-bold text-white">Clock</h3>
                    <p class="text-slate-400 text-sm mt-2">Hit 1 through 20 in order.</p>
                </div>
            </div>
            <button onclick="App.openSettings()" class="mt-8 text-slate-500 hover:text-white text-sm font-bold uppercase tracking-widest">Global Settings</button>
        </div>

        <!-- VIEW: GAME -->
        <div id="view-game" class="hidden w-full h-full flex-col lg:flex-row gap-6 relative pb-2">
            
            <!-- Left: Scorecards -->
            <div class="flex-grow flex flex-col gap-6 lg:w-5/12 overflow-y-auto custom-scroll pr-2 pb-20 lg:pb-0">
                
                <!-- Player 1 -->
                <div id="p1-card" class="glass-panel rounded-2xl p-6 flex flex-col justify-between min-h-[180px] transition-all duration-300 border-l-4 border-l-transparent relative overflow-hidden group">
                    <div class="absolute top-[-20px] right-[-10px] opacity-5 group-hover:opacity-10 transition text-9xl font-black select-none z-0">1</div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <h2 class="font-bold text-slate-200 text-base uppercase tracking-widest flex items-center gap-3">
                                <span id="p1-name">Player 1</span>
                                <span class="text-[10px] font-extrabold bg-green-500/20 text-green-400 border border-green-500/30 px-2 py-1 rounded-md hidden tracking-wider" id="p1-indicator">THROWING</span>
                                <span id="p1-crown" class="hidden text-xl drop-shadow-[0_0_10px_rgba(234,179,8,0.8)]">üëë</span>
                            </h2>
                            <div class="text-xs text-slate-400 font-mono mt-2 font-bold flex items-center gap-2">LEGS <span id="p1-legs" class="text-white text-lg bg-slate-800/50 px-2 rounded">0</span></div>
                        </div>
                        <div class="flex gap-2" id="p1-darts"></div>
                    </div>
                    <div class="flex justify-between items-end mt-4 relative z-10">
                        <div class="text-6xl md:text-7xl font-black font-mono tracking-tighter leading-normal text-white drop-shadow-2xl pb-2" id="p1-score">501</div>
                        <div class="text-right pb-2">
                             <div id="p1-suggestion" class="text-amber-400 font-mono font-bold text-xl animate-pulse drop-shadow-sm h-7"></div>
                             <div class="text-[10px] uppercase text-slate-400 font-bold tracking-widest mt-1" id="p1-sublabel">Checkout</div>
                        </div>
                    </div>
                    <div id="p1-cricket" class="hidden grid-cols-7 gap-1 mt-2 relative z-10"></div>
                </div>

                <!-- Player 2 -->
                <div id="p2-card" class="glass-panel rounded-2xl p-6 flex flex-col justify-between min-h-[180px] transition-all duration-300 border-l-4 border-l-transparent relative overflow-hidden group">
                    <div class="absolute top-[-20px] right-[-10px] opacity-5 group-hover:opacity-10 transition text-9xl font-black select-none z-0">2</div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <h2 class="font-bold text-slate-200 text-base uppercase tracking-widest flex items-center gap-3">
                                <span id="p2-name">Player 2</span>
                                <span class="text-[10px] font-extrabold bg-green-500/20 text-green-400 border border-green-500/30 px-2 py-1 rounded-md hidden tracking-wider" id="p2-indicator">THROWING</span>
                                <span id="p2-crown" class="hidden text-xl drop-shadow-[0_0_10px_rgba(234,179,8,0.8)]">üëë</span>
                            </h2>
                            <div class="text-xs text-slate-400 font-mono mt-2 font-bold flex items-center gap-2">LEGS <span id="p2-legs" class="text-white text-lg bg-slate-800/50 px-2 rounded">0</span></div>
                        </div>
                        <div class="flex gap-2" id="p2-darts"></div>
                    </div>
                    <div class="flex justify-between items-end mt-4 relative z-10">
                        <div class="text-6xl md:text-7xl font-black font-mono tracking-tighter leading-normal text-white drop-shadow-2xl pb-2" id="p2-score">501</div>
                        <div class="text-right pb-2">
                             <div id="p2-suggestion" class="text-amber-400 font-mono font-bold text-xl animate-pulse drop-shadow-sm h-7"></div>
                             <div class="text-[10px] uppercase text-slate-400 font-bold tracking-widest mt-1" id="p2-sublabel">Checkout</div>
                        </div>
                    </div>
                    <div id="p2-cricket" class="hidden grid-cols-7 gap-1 mt-2 relative z-10"></div>
                </div>

                <!-- Voice Control Panel -->
                <div class="glass-panel rounded-2xl p-6 mt-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">Voice Controls</h3>
                        <div class="flex items-center gap-2 cursor-pointer" onclick="VoiceEngine.toggleTrigger()">
                            <label class="text-[10px] uppercase font-bold text-slate-500 cursor-pointer">Trigger</label>
                            <div id="btn-trigger-toggle" class="w-8 h-4 rounded-full bg-slate-700 relative transition-colors"><div class="w-4 h-4 bg-white rounded-full absolute left-0 top-0 transition-transform shadow-sm"></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <button onclick="setMicMode('single')" id="btn-single" class="py-4 px-2 rounded-xl bg-slate-800/40 hover:bg-slate-700/60 text-slate-200 text-xs font-bold transition flex flex-col items-center gap-2 border border-slate-700/50 hover:border-slate-500 group">
                            <span class="text-xl">üé§</span> Single
                        </button>
                        <button onclick="setMicMode('turn')" id="btn-turn" class="py-4 px-2 rounded-xl bg-slate-800/40 hover:bg-slate-700/60 text-slate-200 text-xs font-bold transition flex flex-col items-center gap-2 border border-slate-700/50 hover:border-slate-500 group">
                            <span class="text-xl">üîÑ</span> Turn
                        </button>
                        <button onclick="setMicMode('always')" id="btn-always" class="py-4 px-2 rounded-xl bg-slate-800/40 hover:bg-slate-700/60 text-slate-200 text-xs font-bold transition flex flex-col items-center gap-2 border border-slate-700/50 hover:border-slate-500 group">
                            <span class="text-xl">‚ôæÔ∏è</span> Always
                        </button>
                    </div>
                    <button onclick="stopListening()" class="mt-4 w-full py-3 text-xs font-bold text-red-300 bg-red-500/5 hover:bg-red-500/20 border border-red-500/20 hover:border-red-500/40 rounded-xl transition tracking-wide uppercase">Stop Microphone</button>
                </div>
            </div>

            <!-- Right: Board -->
            <div class="lg:w-7/12 flex flex-col h-full min-h-[40vh] relative gap-4">
                <div class="shrink-0 glass-panel rounded-2xl p-6 flex justify-between items-center bg-indigo-950/20 border-indigo-500/10 shadow-lg">
                    <div class="flex flex-col">
                        <span class="text-[11px] uppercase text-indigo-300 font-bold tracking-widest mb-1">Turn Total</span>
                        <span id="current-turn-score" class="text-5xl font-mono font-bold text-white leading-none">0</span>
                    </div>
                    <div class="h-14 w-[1px] bg-white/10 mx-8"></div>
                    <div class="flex-grow text-right overflow-hidden flex flex-col justify-center">
                        <div id="status-message" class="text-xl font-bold text-white truncate leading-tight">Ready</div>
                        <div id="mic-status-text" class="text-xs text-slate-400 font-mono truncate mt-2 font-bold">Voice: OFF</div>
                    </div>
                </div>

                <div class="glass-panel rounded-3xl flex-grow relative flex items-center justify-center p-8 overflow-hidden bg-black/20 shadow-inner border-slate-700/30">
                    <svg id="dartboard" viewBox="-220 -220 440 440" class="w-full h-full filter drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]"></svg>
                    <div id="hit-overlay" class="absolute inset-0 pointer-events-none"></div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="absolute inset-0 z-[80] bg-slate-900/95 backdrop-blur-xl hidden flex-col items-center justify-center p-4">
                <div class="glass-panel p-8 rounded-2xl w-full max-w-md border-slate-700">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">‚öôÔ∏è Game Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Starting Score</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="Game.setStartScore(301)" class="p-2 rounded bg-slate-800 text-xs font-bold hover:bg-slate-700 border border-slate-600 setting-score" data-val="301">301</button>
                                <button onclick="Game.setStartScore(501)" class="p-2 rounded bg-slate-800 text-xs font-bold hover:bg-slate-700 border border-slate-600 setting-score" data-val="501">501</button>
                                <button onclick="Game.setStartScore(701)" class="p-2 rounded bg-slate-800 text-xs font-bold hover:bg-slate-700 border border-slate-600 setting-score" data-val="701">701</button>
                                <button onclick="Game.setStartScore(1001)" class="p-2 rounded bg-slate-800 text-xs font-bold hover:bg-slate-700 border border-slate-600 setting-score" data-val="1001">1001</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-bold text-slate-300">Double In</label>
                            <input type="checkbox" id="setting-double-in" onchange="Game.toggleDoubleIn(this.checked)" class="w-5 h-5 rounded bg-slate-800 border-slate-600">
                        </div>
                        <div>
                            <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Player 1 Name</label>
                            <input type="text" id="setting-p1-name" onchange="Game.updateNames()" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Player 2 Name (or 'CPU' for Bot)</label>
                            <input type="text" id="setting-p2-name" onchange="Game.updateNames()" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                        </div>
                    </div>
                    <button onclick="App.closeSettings()" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition">Save & Close</button>
                </div>
            </div>

            <!-- Virtual Keypad -->
            <div id="virtual-keypad" class="absolute bottom-0 left-0 right-0 glass-panel border-t border-slate-600 transform translate-y-full transition-transform duration-300 z-50 flex flex-col p-6 gap-4 shadow-2xl bg-[#0f172a] rounded-t-3xl">
                <div class="flex justify-between items-center px-2">
                    <span class="text-xs font-bold uppercase text-slate-400 tracking-widest">Manual Entry</span>
                    <button onclick="App.toggleKeypad()" class="text-slate-400 hover:text-white p-2 transition">‚úï</button>
                </div>
                <div class="grid grid-cols-4 gap-4 h-72">
                    <button onclick="Game.inputDigit(1)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">1</button>
                    <button onclick="Game.inputDigit(2)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">2</button>
                    <button onclick="Game.inputDigit(3)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">3</button>
                    <button onclick="Game.submitScore(25)" class="bg-emerald-900/30 text-emerald-400 rounded-2xl font-bold border border-emerald-500/20">25</button>
                    <button onclick="Game.inputDigit(4)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">4</button>
                    <button onclick="Game.inputDigit(5)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">5</button>
                    <button onclick="Game.inputDigit(6)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">6</button>
                    <button onclick="Game.submitScore(50)" class="bg-rose-900/30 text-rose-400 rounded-2xl font-bold border border-rose-500/20">Bull</button>
                    <button onclick="Game.inputDigit(7)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">7</button>
                    <button onclick="Game.inputDigit(8)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">8</button>
                    <button onclick="Game.inputDigit(9)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">9</button>
                    <button onclick="Game.inputDigit(0)" class="bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 text-white">0</button>
                    <button onclick="Game.clearInput()" class="bg-slate-700 rounded-2xl text-red-300 font-bold col-span-2">CLEAR</button>
                    <button onclick="Game.submitInputBuffer()" class="bg-indigo-600 rounded-2xl text-white font-bold col-span-2 text-xl">ENTER</button>
                </div>
                <div id="keypad-display" class="h-16 bg-black/40 rounded-2xl flex items-center justify-center text-5xl font-mono text-indigo-400 font-bold border border-white/5"></div>
            </div>
        </div>
    </main>

    <!-- Winner Modal -->
    <div id="winner-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-xl hidden flex-col items-center justify-center text-center p-6">
        <div class="text-8xl mb-6 animate-bounce">üèÜ</div>
        <h1 id="winner-name" class="text-4xl md:text-6xl font-black text-white mb-2 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-amber-600">Player 1 Wins!</h1>
        <div class="flex gap-4 mt-8">
             <button onclick="App.setView('dashboard')" class="bg-white text-slate-900 px-10 py-4 rounded-2xl font-bold hover:scale-105 transition">Menu</button>
             <button onclick="Game.reset()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold hover:scale-105 transition">Rematch</button>
        </div>
    </div>

    <script>
        const AudioEngine = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if(!this.ctx) this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration) {
                if (!this.ctx) this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.15, this.ctx.currentTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playHit: function() { this.playTone(400, 'sine', 0.15); },
            playDouble: function() { this.playTone(600, 'triangle', 0.2); },
            playTriple: function() { this.playTone(800, 'square', 0.15); },
            playBust: function() { this.playTone(150, 'sawtooth', 0.4); },
            playWin: function() {
                if (!this.ctx) this.init();
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => setTimeout(() => this.playTone(freq, 'triangle', 0.3), i * 150));
            },
            play180: function() {
                this.playWin();
                this.speak("One Hundred and Eighty!");
            },
            speak: function(text) {
                if(window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 1.1;
                    window.speechSynthesis.speak(u);
                }
            }
        };

        const Confetti = {
            canvas: document.getElementById('confetti-canvas'),
            ctx: document.getElementById('confetti-canvas').getContext('2d'),
            particles: [],
            active: false,
            init: function() { this.resize(); window.addEventListener('resize', () => this.resize()); },
            resize: function() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            start: function() {
                this.active = true;
                this.particles = [];
                for(let i=0; i<150; i++) this.particles.push({x: Math.random()*this.canvas.width, y: Math.random()*this.canvas.height-this.canvas.height, color: ['#a864fd','#29cdff','#78ff44','#ff718d','#fdff6a'][Math.floor(Math.random()*5)], size: Math.random()*8+4, speedY: Math.random()*3+2, speedX: Math.random()*2-1, rotation: Math.random()*360, rotationSpeed: Math.random()*10-5});
                this.loop();
            },
            loop: function() {
                if(!this.active) { this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); return; }
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                this.particles.forEach(p => { p.y+=p.speedY; p.x+=p.speedX; p.rotation+=p.rotationSpeed; if(p.y>this.canvas.height) p.y=-20; this.ctx.save(); this.ctx.translate(p.x,p.y); this.ctx.rotate(p.rotation*Math.PI/180); this.ctx.fillStyle=p.color; this.ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); this.ctx.restore(); });
                requestAnimationFrame(() => this.loop());
            },
            stop: function() { this.active = false; }
        };

        const Game = {
            mode: 'x01', scores: [501, 501], legs: [0, 0], cricket: [[0,0,0,0,0,0,0], [0,0,0,0,0,0,0]],
            currentPlayer: 0, turn: { dartsThrown: 0, score: 0, history: [], startScore: 501, bust: false, won: false },
            historyStack: [], redoStack: [], settings: { doubleOut: true, doubleIn: false, startScore: 501, p1Name: "Player 1", p2Name: "Player 2" },
            inputBuffer: '', doubleInMet: [false, false],

            init: function(mode) {
                // Try load from local storage
                const saved = localStorage.getItem('darts_state');
                if(saved && !mode) {
                    try {
                        const s = JSON.parse(saved);
                        this.scores=s.scores; this.legs=s.legs; this.currentPlayer=s.currentPlayer; this.settings=s.settings; this.mode=s.mode; this.doubleInMet=s.doubleInMet || [false,false];
                        this.cricket = s.cricket || [[0,0,0,0,0,0,0], [0,0,0,0,0,0,0]];
                        // Don't restore partial turn to avoid confusion, just reset turn
                        this.resetTurn();
                    } catch(e) { this.resetState(mode || 'x01'); }
                } else {
                    this.resetState(mode || 'x01');
                }
                Confetti.init(); AudioEngine.init(); UI.render();
                if(this.settings.p1Name) { document.getElementById('setting-p1-name').value = this.settings.p1Name; document.getElementById('p1-name').textContent = this.settings.p1Name; }
                if(this.settings.p2Name) { document.getElementById('setting-p2-name').value = this.settings.p2Name; document.getElementById('p2-name').textContent = this.settings.p2Name; }
                document.getElementById('setting-double-in').checked = this.settings.doubleIn;
                this.updateSettingsUI();
            },
            resetState: function(mode) {
                this.mode = mode; this.scores = [this.settings.startScore, this.settings.startScore];
                this.legs = [0, 0]; this.cricket = [[0,0,0,0,0,0,0], [0,0,0,0,0,0,0]];
                this.currentPlayer = 0; this.historyStack = []; this.redoStack = [];
                this.doubleInMet = [!this.settings.doubleIn, !this.settings.doubleIn];
                this.resetTurn();
            },
            resetTurn: function() {
                this.turn = { dartsThrown: 0, score: 0, history: [], startScore: this.scores[this.currentPlayer], bust: false, won: false };
            },
            processThrow: function(points, multiplier, label) {
                if(this.turn.won || this.turn.bust || this.turn.dartsThrown >= 3) return;
                this.saveState();
                
                // Double In Logic
                if(!this.doubleInMet[this.currentPlayer]) {
                    if(multiplier === 2 || label.includes("Bullseye")) {
                        this.doubleInMet[this.currentPlayer] = true;
                        AudioEngine.speak("Double In");
                    } else {
                        points = 0; label = label + " (No In)";
                    }
                }

                if(points === 0) AudioEngine.playTone(150, 'sawtooth', 0.1);
                else if(multiplier === 3) AudioEngine.playTriple();
                else if(multiplier === 2) AudioEngine.playDouble();
                else AudioEngine.playHit();
                
                if(this.mode === 'x01') this.handleX01(points, multiplier, label);
                else if(this.mode === 'cricket') this.handleCricket(points, multiplier, label);
                else if(this.mode === 'atc') this.handleATC(points, multiplier, label);

                this.turn.dartsThrown++; this.turn.history.push(label);
                
                // 180 Check
                if(this.turn.history.length === 3 && this.turn.history.every(h => h.includes("Triple 20"))) {
                    UI.show180();
                }

                UI.render(); this.persist();
                if(this.turn.dartsThrown >= 3 && !this.turn.bust && !this.turn.won) setTimeout(() => this.nextTurn(), 1000);
            },
            handleX01: function(pts, mul, label) {
                const rem = this.scores[this.currentPlayer] - pts;
                let bust = false;
                if(rem < 0 || rem === 1) bust = true;
                else if(rem === 0 && this.settings.doubleOut && !(mul === 2 || label.includes("Bullseye"))) bust = true;

                if(bust) {
                    this.turn.bust = true; AudioEngine.playBust(); AudioEngine.speak("Bust");
                    this.scores[this.currentPlayer] = this.turn.startScore;
                    setTimeout(() => this.nextTurn(), 1500);
                } else {
                    this.scores[this.currentPlayer] = rem; this.turn.score += pts;
                    if(rem === 0) this.winLeg();
                }
            },
            handleCricket: function(pts, mul, label) {
                const map = {20:0,19:1,18:2,17:3,16:4,15:5,25:6,50:6}, raw=pts/mul, idx=map[label.includes("Bull")? (label==="Bullseye"?50:25) : raw];
                if(idx === undefined) return;
                const p = this.cricket[this.currentPlayer], opp = this.cricket[this.currentPlayer^1];
                let hits = mul; if(pts===50) hits=2;
                let needed = 3 - p[idx]; if(needed<0) needed=0;
                if(hits <= needed) p[idx] += hits;
                else {
                    p[idx] = 3;
                    if(opp[idx] < 3) {
                        const val = idx===6?25:(20-idx);
                        const ptsEarned = (hits-needed)*val;
                        this.scores[this.currentPlayer] += ptsEarned;
                        AudioEngine.speak(ptsEarned.toString());
                    }
                }
                if(p.every(c=>c>=3) && this.scores[this.currentPlayer] >= this.scores[this.currentPlayer^1]) this.winLeg();
            },
            handleATC: function(pts, mul, label) {
                let raw = pts/mul; if(label.includes("Bull")) raw = (label === "Bullseye") ? 50 : 25;
                if(raw === (this.scores[this.currentPlayer] + 1)) {
                    this.scores[this.currentPlayer]++;
                    if(this.scores[this.currentPlayer] === 20) this.winLeg();
                }
            },
            saveState: function() {
                this.historyStack.push(JSON.parse(JSON.stringify({ scores: this.scores, curr: this.currentPlayer, turn: this.turn, legs: this.legs, cricket: this.cricket, in: this.doubleInMet })));
                if(this.historyStack.length > 50) this.historyStack.shift(); this.redoStack = [];
            },
            undo: function() {
                if(this.historyStack.length === 0) return;
                this.redoStack.push(JSON.parse(JSON.stringify({ scores: this.scores, curr: this.currentPlayer, turn: this.turn, legs: this.legs, cricket: this.cricket, in: this.doubleInMet })));
                const s = this.historyStack.pop(); this.restoreState(s); AudioEngine.speak("Correction");
            },
            redo: function() {
                if(this.redoStack.length === 0) return;
                this.historyStack.push(JSON.parse(JSON.stringify({ scores: this.scores, curr: this.currentPlayer, turn: this.turn, legs: this.legs, cricket: this.cricket, in: this.doubleInMet })));
                const s = this.redoStack.pop(); this.restoreState(s); AudioEngine.speak("Redo");
            },
            restoreState: function(s) {
                this.scores=s.scores; this.legs=s.legs; this.currentPlayer=s.curr; this.turn=s.turn; this.cricket=s.cricket; this.doubleInMet=s.in||[true,true]; UI.render(); this.persist();
            },
            winLeg: function() {
                this.turn.won = true; this.legs[this.currentPlayer]++; AudioEngine.playWin(); AudioEngine.speak("Game Shot"); Confetti.start();
                document.getElementById('winner-name').textContent = `${this.settings[this.currentPlayer===0?'p1Name':'p2Name']} Wins!`;
                document.getElementById('winner-modal').classList.remove('hidden'); document.getElementById('winner-modal').classList.add('flex');
                this.persist();
            },
            nextTurn: function() {
                this.currentPlayer ^= 1; this.resetTurn(); UI.render(); this.persist();
                const name = this.settings[this.currentPlayer===0?'p1Name':'p2Name'];
                AudioEngine.speak(name + " to throw");
                if(VoiceEngine.mode === 'turn') VoiceEngine.stopListening();
                if(name.toLowerCase() === 'cpu' || name.toLowerCase() === 'bot') setTimeout(() => this.botThrow(), 1500);
            },
            botThrow: function() {
                // Simple Bot Logic
                const score = this.scores[this.currentPlayer];
                let targets = [];
                if(this.mode === 'x01') {
                    if(score > 60) targets = [20, 20, 20];
                    else if(score > 40) targets = [score-40, 20, 20]; // Setup
                    else if(score > 0 && score % 2 === 0) targets = [score]; // Checkout attempt (simulated as single for simplicity for now, handled by manual logic mostly)
                    else targets = [1];
                } else targets = [20, 19, 18];
                
                // Simulate throws
                let i=0;
                const interval = setInterval(() => {
                    if(this.turn.won || this.turn.bust || i>=3) { clearInterval(interval); return; }
                    let val = targets[i] || 20;
                    let mul = 1; 
                    if(val > 40) { val = 20; mul = 3; } // Triples
                    if(this.scores[this.currentPlayer] <= 40 && this.scores[this.currentPlayer]%2==0 && this.mode==='x01') { val = this.scores[this.currentPlayer]/2; mul=2; }
                    
                    let label = (mul==1?"Single ":mul==2?"Double ":"Triple ") + val;
                    this.processThrow(val*mul, mul, label);
                    i++;
                }, 1000);
            },
            persist: function() {
                localStorage.setItem('darts_state', JSON.stringify({ scores: this.scores, legs: this.legs, currentPlayer: this.currentPlayer, settings: this.settings, mode: this.mode, cricket: this.cricket, doubleInMet: this.doubleInMet }));
            },
            setStartScore: function(s) { this.settings.startScore = s; this.updateSettingsUI(); },
            toggleDoubleIn: function(v) { this.settings.doubleIn = v; },
            updateNames: function() { 
                this.settings.p1Name = document.getElementById('setting-p1-name').value || "Player 1";
                this.settings.p2Name = document.getElementById('setting-p2-name').value || "Player 2";
                document.getElementById('p1-name').textContent = this.settings.p1Name;
                document.getElementById('p2-name').textContent = this.settings.p2Name;
            },
            updateSettingsUI: function() {
                document.querySelectorAll('.setting-score').forEach(b => {
                    if(parseInt(b.dataset.val) === this.settings.startScore) b.classList.add('bg-indigo-600', 'border-indigo-500');
                    else b.classList.remove('bg-indigo-600', 'border-indigo-500');
                });
            },
            // Keypad
            inputDigit: function(d) { this.inputBuffer += d; document.getElementById('keypad-display').textContent = this.inputBuffer; },
            clearInput: function() { this.inputBuffer = ''; document.getElementById('keypad-display').textContent = ''; },
            submitInputBuffer: function() { const val = parseInt(this.inputBuffer); if(!isNaN(val)) this.submitScore(val); this.clearInput(); },
            submitScore: function(val) {
                let mul = 1; let lbl = "Single " + val;
                if(val === 50) { mul=2; lbl="Bullseye"; } else if(val === 25) { lbl="Outer Bull"; }
                else if(val <= 40 && val%2===0) { mul=2; lbl="Double "+val/2; }
                else if(val <= 60 && val%3===0) { mul=3; lbl="Triple "+val/3; }
                this.processThrow(val, mul, lbl);
            },
            reset: function() { this.resetState(this.mode); Confetti.stop(); document.getElementById('winner-modal').classList.add('hidden'); document.getElementById('winner-modal').classList.remove('flex'); UI.render(); }
        };

        const UI = {
            render: function() {
                const p1Name = Game.settings.p1Name; const p2Name = Game.settings.p2Name;
                document.getElementById('p1-name').textContent = p1Name; document.getElementById('p2-name').textContent = p2Name;
                
                const p1Lead = Game.legs[0] > Game.legs[1] || (Game.legs[0]===Game.legs[1] && Game.scores[0] < Game.scores[1] && Game.mode === 'x01');
                const p2Lead = Game.legs[1] > Game.legs[0] || (Game.legs[1]===Game.legs[0] && Game.scores[1] < Game.scores[0] && Game.mode === 'x01');
                document.getElementById('p1-crown').classList.toggle('hidden', !p1Lead); document.getElementById('p2-crown').classList.toggle('hidden', !p2Lead);

                // Active State
                const p1C = document.getElementById('p1-card'), p2C = document.getElementById('p2-card');
                if(Game.currentPlayer === 0) {
                    p1C.classList.add('player-active'); p1C.classList.remove('opacity-60');
                    p2C.classList.remove('player-active'); p2C.classList.add('opacity-60');
                    document.getElementById('p1-indicator').classList.remove('hidden'); document.getElementById('p2-indicator').classList.add('hidden');
                } else {
                    p2C.classList.add('player-active'); p2C.classList.remove('opacity-60');
                    p1C.classList.remove('player-active'); p1C.classList.add('opacity-60');
                    document.getElementById('p2-indicator').classList.remove('hidden'); document.getElementById('p1-indicator').classList.add('hidden');
                }

                document.getElementById('p1-legs').textContent = Game.legs[0]; document.getElementById('p2-legs').textContent = Game.legs[1];
                document.getElementById('p1-score').textContent = Game.scores[0]; document.getElementById('p2-score').textContent = Game.scores[1];
                document.getElementById('current-turn-score').textContent = Game.turn.score;
                document.getElementById('status-message').textContent = Game.turn.bust ? "BUST" : `${Game.settings[Game.currentPlayer===0?'p1Name':'p2Name']}'s Turn`;

                // Checkout Visualization
                document.querySelectorAll('.segment-highlight').forEach(el => el.classList.remove('segment-highlight'));
                if(Game.mode === 'x01') {
                    document.getElementById('p1-sublabel').textContent = "Checkout"; document.getElementById('p2-sublabel').textContent = "Checkout";
                    document.getElementById('p1-cricket').classList.add('hidden'); document.getElementById('p2-cricket').classList.add('hidden');
                    const sug = this.getCheckout(Game.scores[Game.currentPlayer]);
                    document.getElementById(Game.currentPlayer===0?'p1-suggestion':'p2-suggestion').textContent = sug || "";
                    if(sug) this.highlightCheckout(sug);
                } else if(Game.mode === 'cricket') {
                    // ... Cricket UI ...
                    document.getElementById('p1-sublabel').textContent = "Score"; document.getElementById('p2-sublabel').textContent = "Score";
                    this.renderCricket(0); this.renderCricket(1);
                    document.getElementById('p1-cricket').classList.remove('hidden'); document.getElementById('p1-cricket').classList.add('grid');
                    document.getElementById('p2-cricket').classList.remove('hidden'); document.getElementById('p2-cricket').classList.add('grid');
                } else {
                    // ATC
                    document.getElementById('p1-sublabel').textContent = "Target"; document.getElementById('p2-sublabel').textContent = "Target";
                    document.getElementById(Game.currentPlayer===0?'p1-suggestion':'p2-suggestion').textContent = Game.scores[Game.currentPlayer]+1;
                }
                this.renderDarts(0); this.renderDarts(1);
            },
            renderDarts: function(pid) {
                const el = document.getElementById(pid===0?'p1-darts':'p2-darts'); el.innerHTML = '';
                if(pid===Game.currentPlayer) {
                    for(let i=0; i<3; i++) {
                        const filled = i < Game.turn.dartsThrown;
                        const d = document.createElement('div');
                        d.className = `w-4 h-4 rounded-full border border-slate-700 ${filled ? 'bg-green-400 shadow-[0_0_10px_#4ade80] border-transparent' : 'bg-slate-800'}`;
                        el.appendChild(d);
                    }
                }
            },
            renderCricket: function(pid) {
                const el = document.getElementById(pid===0?'p1-cricket':'p2-cricket'); el.innerHTML = '';
                const labels = ['20','19','18','17','16','15','B'];
                labels.forEach((lbl, i) => {
                    const hits = Game.cricket[pid][i];
                    const d = document.createElement('div'); d.className = "flex flex-col items-center bg-black/20 rounded py-1";
                    let clr = hits>=3?'text-green-400':hits>0?'text-green-500':'text-slate-600';
                    d.innerHTML = `<span class="text-[9px] text-slate-500">${lbl}</span><span class="${clr} font-black text-sm">${hits==0?'-':hits==1?'/':hits==2?'X':'‚¶ª'}</span>`;
                    el.appendChild(d);
                });
            },
            getCheckout: function(score) {
                if (score > 170) return "T20 T20 T20"; // Suggest scoring max
                
                // Comprehensive Checkout Table
                const checkouts = {
                    170: "T20 T20 Bull", 167: "T20 T19 Bull", 164: "T20 T18 Bull", 161: "T20 T17 Bull", 160: "T20 T20 D20",
                    158: "T20 T20 D19", 157: "T20 T19 D20", 156: "T20 T20 D18", 155: "T20 T19 D19", 154: "T20 T18 D20",
                    153: "T20 T19 D18", 152: "T20 T20 D16", 151: "T20 T17 D20", 150: "T20 T18 D18", 149: "T20 T19 D16",
                    148: "T20 T20 D14", 147: "T20 T17 D18", 146: "T20 T18 D16", 145: "T20 T15 D20", 144: "T20 T20 D12",
                    143: "T20 T17 D16", 142: "T20 T14 D20", 141: "T20 T19 D12", 140: "T20 T16 D16", 139: "T19 T14 D20",
                    138: "T20 T18 D12", 137: "T19 T16 D16", 136: "T20 T20 D8", 135: "Bull T15 D20", 134: "T20 T14 D16",
                    133: "T20 T19 D8", 132: "T20 T16 D12", 131: "T20 T13 D16", 130: "T20 20 Bull", 129: "T19 T16 D12",
                    128: "T18 T14 D16", 127: "T20 T17 D8", 126: "T19 19 Bull", 125: "Bull 25 Bull", 124: "T20 T16 D8",
                    123: "T19 T16 D9", 122: "T18 18 Bull", 121: "T20 11 Bull", 120: "T20 20 D20", 119: "T19 12 Bull",
                    118: "T20 18 D20", 117: "T20 17 D20", 116: "T20 16 D20", 115: "T20 15 D20", 114: "T20 14 D20",
                    113: "T20 13 D20", 112: "T20 12 D20", 111: "T20 19 D16", 110: "T20 10 D20", 109: "T20 17 D16",
                    108: "T20 16 D16", 107: "T19 10 D20", 106: "T20 14 D16", 105: "T20 13 D16", 104: "T18 18 D16",
                    103: "T20 3 D20", 102: "T20 10 D16", 101: "T17 10 D20", 100: "T20 D20", 99: "T19 10 D16",
                    98: "T20 D19", 97: "T19 D20", 96: "T20 D18", 95: "T19 D19", 94: "T18 D20", 93: "T19 D18",
                    92: "T20 D16", 91: "T17 D20", 90: "T18 D18", 89: "T19 D16", 88: "T16 D20", 87: "T17 D18",
                    86: "T18 D16", 85: "T15 D20", 84: "T20 D12", 83: "T17 D16", 82: "T14 D20", 81: "T19 D12",
                    80: "T20 D10", 79: "T13 D20", 78: "T18 D12", 77: "T19 D10", 76: "T20 D8", 75: "T17 D12",
                    74: "T14 D16", 73: "T19 D8", 72: "T16 D12", 71: "T13 D16", 70: "T18 D8", 69: "T15 D12",
                    68: "T20 D4", 67: "T17 D8", 66: "T10 D18", 65: "T19 D4", 64: "T16 D8", 63: "T13 D12",
                    62: "T10 D16", 61: "25 D18", 60: "20 D20", 59: "19 D20", 58: "18 D20", 57: "17 D20",
                    56: "16 D20", 55: "15 D20", 54: "14 D20", 53: "13 D20", 52: "12 D20", 51: "11 D20",
                    50: "10 D20", 49: "9 D20", 48: "16 D16", 47: "7 D20", 46: "6 D20", 45: "5 D20",
                    44: "4 D20", 43: "3 D20", 42: "2 D20", 41: "9 D16", 40: "D20", 39: "7 D16",
                    38: "D19", 37: "5 D16", 36: "D18", 35: "3 D16", 34: "D17", 33: "1 D16", 32: "D16",
                    31: "15 D8", 30: "D15", 29: "13 D8", 28: "D14", 27: "11 D8", 26: "D13", 25: "9 D8",
                    24: "D12", 23: "7 D8", 22: "D11", 21: "5 D8", 20: "D10", 19: "3 D8", 18: "D9",
                    17: "1 D8", 16: "D8", 15: "7 D4", 14: "D7", 13: "5 D4", 12: "D6", 11: "3 D4",
                    10: "D5", 9: "1 D4", 8: "D4", 7: "3 D2", 6: "D3", 5: "1 D2", 4: "D2", 3: "1 D1", 2: "D1"
                };
                return checkouts[score] || "No checkout";
            },
            highlightCheckout: function(str) {
                // Clear existing
                document.querySelectorAll('.segment-highlight').forEach(el => el.classList.remove('segment-highlight'));
                if (!str || str === "No checkout") return;

                // Simple parser for the FIRST target in the sequence
                let target = str.split(' ')[0]; // e.g. "T20" from "T20 T20 D20"
                let id = "";
                
                if(target.startsWith('T')) id = `segment-t-${target.substring(1)}`;
                else if(target.startsWith('D')) id = `segment-d-${target.substring(1)}`;
                else if(target === 'Bull') id = 'segment-50';
                else if(target === '25') id = 'segment-25';
                else if(!isNaN(target)) id = `segment-s-${target}`; // Default to outer single for setup shots
                
                if(id) {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('segment-highlight');
                }
            },
            show180: function() {
                const el = document.getElementById('one80-overlay');
                el.classList.remove('hidden');
                AudioEngine.play180();
                setTimeout(() => el.classList.add('hidden'), 2000);
            }
        };

        const VoiceEngine = {
            recognition: null, isListening: false, mode: 'off', useTrigger: false, triggerWord: "dart",
            init: function() {
                if(!('webkitSpeechRecognition' in window)) return;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SR(); this.recognition.continuous = false; this.recognition.lang = 'en-US';
                this.recognition.onstart = () => { this.isListening = true; this.updateUI(); };
                this.recognition.onend = () => { this.isListening = false; this.updateUI(); if(this.mode==='always' || (this.mode==='turn' && !Game.turn.won && Game.turn.dartsThrown<3)) this.startListening(); else this.setMode('off'); };
                this.recognition.onresult = (e) => {
                    const t = e.results[0][0].transcript.toLowerCase().trim();
                    console.log("Heard:", t);
                    if(this.useTrigger) {
                        if(t.startsWith(this.triggerWord) || t.startsWith("score")) this.parse(t.replace(this.triggerWord, "").replace("score", "").trim());
                    } else this.parse(t);
                };
            },
            toggleTrigger: function() {
                this.useTrigger = !this.useTrigger;
                const btn = document.querySelector('#btn-trigger-toggle div');
                btn.style.transform = this.useTrigger ? "translateX(100%)" : "translateX(0)";
                document.getElementById('btn-trigger-toggle').classList.toggle('bg-green-500', this.useTrigger);
            },
            setMode: function(m) { if(!this.recognition) AudioEngine.init(); this.init(); if(this.isListening && this.mode === m) { this.stopListening(); return; } this.mode = m; if(this.isListening) this.recognition.stop(); if(m !== 'off') setTimeout(() => this.startListening(), 100); this.updateUI(); },
            startListening: function() { if(this.isListening) return; try{this.recognition.start();}catch(e){} },
            stopListening: function() { this.mode = 'off'; if(this.recognition) this.recognition.stop(); },
            updateUI: function() {
                ['btn-single','btn-turn','btn-always'].forEach(id => document.getElementById(id).classList.remove('mic-btn-active'));
                if(this.isListening && this.mode !== 'off') document.getElementById(`btn-${this.mode}`).classList.add('mic-btn-active');
                document.getElementById('mic-status-text').textContent = this.isListening ? `Voice: ${this.mode.toUpperCase()}` : "Voice: OFF";
            },
            parse: function(txt) {
                if(txt.includes("undo")) { Game.undo(); return; }
                if(txt.includes("redo")) { Game.redo(); return; }
                let norm = txt.replace(/[.,]/g, ' ');
                const map = {
                    'one':1, 'two':2, 'three':3, 'four':4, 'five':5, 'six':6, 'seven':7, 'eight':8, 'nine':9, 'ten':10, 
                    'eleven':11, 'twelve':12, 'thirteen':13, 'fourteen':14, 'fifteen':15, 'sixteen':16, 'seventeen':17, 'eighteen':18, 'nineteen':19, 'twenty':20,
                    'double': 'd', 'triple': 't', 'treble': 't', 'bull': 'b', 'bullseye': 'b'
                };
                Object.keys(map).forEach(k => { norm = norm.replace(new RegExp(k, 'g'), map[k]); });
                const parts = norm.split(' ');
                let mul = 1;
                for(let part of parts) {
                    if(part === 'd') { mul=2; continue; }
                    if(part === 't') { mul=3; continue; }
                    if(part.includes('b')) { Game.processThrow(part==='b'?25:50, part==='b'?1:2, "Bull"); mul=1; continue; }
                    const val = parseInt(part);
                    if(!isNaN(val) && val <= 20) {
                        const lbl = (mul===1?"Single ":mul===2?"Double ":"Triple ") + val;
                        Game.processThrow(val*mul, mul, lbl);
                        mul = 1;
                    }
                }
            }
        };

        const App = {
            toggleKeypad: function() { document.getElementById('virtual-keypad').classList.toggle('translate-y-full'); },
            openSettings: function() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); },
            closeSettings: function() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); },
            setView: function(v) {
                document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-game').classList.remove('flex'); document.getElementById('view-game').classList.add('hidden'); document.getElementById('game-controls').classList.add('hidden');
                if(v === 'dashboard') document.getElementById('view-dashboard').classList.remove('hidden');
                else { document.getElementById('view-game').classList.remove('hidden'); document.getElementById('view-game').classList.add('flex'); document.getElementById('game-controls').classList.remove('hidden'); }
            },
            startGame: function(mode) { this.setView('game'); Game.init(mode); }
        };

        function setMicMode(m) { VoiceEngine.setMode(m); }
        function stopListening() { VoiceEngine.stopListening(); }
        function manualEditScore() { Game.manualEditScore(); }
        window.addEventListener('load', () => { Dartboard.init(); });

        const Dartboard = {
            init: function() {
                const svg = document.getElementById('dartboard');
                const sectors = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
                const r = { do: 170, di: 162, to: 107, ti: 99, bo: 16, bi: 6 };
                sectors.forEach((num, i) => {
                    const a = 360/20, s = -90-(a/2)+(i*a), e = s+a, ev = i%2===0;
                    // Added IDs for checkout highlighting (e.g., id="segment-d-20")
                    this.arc(svg, r.to, r.di, s, e, ev?'#0f172a':'#cbd5e1', num, 1, `Single ${num}`, `segment-s-${num}`);
                    this.arc(svg, r.bo, r.ti, s, e, ev?'#0f172a':'#cbd5e1', num, 1, `Single ${num}`, `segment-si-${num}`);
                    this.arc(svg, r.di, r.do, s, e, ev?'#ef4444':'#22c55e', num, 2, `Double ${num}`, `segment-d-${num}`);
                    this.arc(svg, r.ti, r.to, s, e, ev?'#ef4444':'#22c55e', num, 3, `Triple ${num}`, `segment-t-${num}`);
                    const ta = (s+e)/2*Math.PI/180;
                    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    txt.setAttribute("x", Math.cos(ta)*195); txt.setAttribute("y", Math.sin(ta)*195);
                    txt.setAttribute("class", "dartboard-text"); txt.textContent = num;
                    svg.appendChild(txt);
                });
                const ob = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                ob.setAttribute("r", r.bo); ob.setAttribute("fill", "#22c55e"); ob.setAttribute("class", "dartboard-segment"); ob.setAttribute("id", "segment-25");
                ob.onclick = (e) => this.click(e, 25, 1, "Outer Bull"); svg.appendChild(ob);
                const ib = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                ib.setAttribute("r", r.bi); ib.setAttribute("fill", "#ef4444"); ib.setAttribute("class", "dartboard-segment"); ib.setAttribute("id", "segment-50");
                ib.onclick = (e) => this.click(e, 50, 2, "Bullseye"); svg.appendChild(ib);
            },
            arc: function(svg, r1, r2, a1, a2, col, v, m, l, id) {
                const rad = d => d * Math.PI / 180;
                const x1 = Math.cos(rad(a1))*r2, y1 = Math.sin(rad(a1))*r2;
                const x2 = Math.cos(rad(a2))*r2, y2 = Math.sin(rad(a2))*r2;
                const x3 = Math.cos(rad(a2))*r1, y3 = Math.sin(rad(a2))*r1;
                const x4 = Math.cos(rad(a1))*r1, y4 = Math.sin(rad(a1))*r1;
                const d = `M ${x1} ${y1} A ${r2} ${r2} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${r1} ${r1} 0 0 0 ${x4} ${y4} Z`;
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                p.setAttribute("d", d); p.setAttribute("fill", col); p.setAttribute("class", "dartboard-segment"); if(id) p.setAttribute("id", id);
                p.onclick = (e) => this.click(e, v*m, m, l);
                svg.appendChild(p);
            },
            click: function(e, pts, mul, lbl) {
                const m = document.createElement('div'); m.className = 'hit-marker';
                m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
                document.body.appendChild(m); setTimeout(() => m.remove(), 600);
                Game.processThrow(pts, mul, lbl);
            }
        };
        // Hooking up the highlighter
        UI.highlightCheckout = function(str) {
            // Very simple parser for first dart only
            let target = str.split(' ')[0]; // e.g. "T20"
            let id = "";
            if(target.startsWith('T')) id = `segment-t-${target.substring(1)}`;
            else if(target.startsWith('D')) id = `segment-d-${target.substring(1)}`;
            else if(target === 'Bull') id = 'segment-50';
            else if(target === '25') id = 'segment-25';
            else if(!isNaN(target)) id = `segment-s-${target}`; // Default to outer single
            
            if(id) {
                const el = document.getElementById(id);
                if(el) el.classList.add('segment-highlight');
            }
        };
    </script>
</body>
</html>